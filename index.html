<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma Dev Mode Mastery Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a minimal, playful, dark-mode look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* Modern gradient + subtle grid */
            background:
                radial-gradient(1200px 600px at 10% -10%, rgba(37, 99, 235, 0.18), transparent 60%),
                radial-gradient(900px 500px at 100% 0%, rgba(16, 185, 129, 0.18), transparent 60%),
                linear-gradient(#0d1117, #0d1117),
                linear-gradient(transparent 0, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: auto, auto, 100% 100%, 24px 24px; /* grid size */
            background-repeat: no-repeat, no-repeat, no-repeat, repeat;
            color: #e5e7eb; /* Off-White Text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        #quiz-container {
            max-width: 650px;
            width: 100%;
            background-color: rgba(26, 30, 34, 0.65); /* glass */
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px) saturate(140%);
            -webkit-backdrop-filter: blur(10px) saturate(140%);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45), inset 0 1px 0 rgba(255,255,255,0.04);
            border-radius: 14px;
        }
        
        .option-button {
            transition: all 0.2s ease;
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            border: 2px solid #30363d;
        }

        .option-button:not(.disabled):hover {
            background-color: #232b38;
            border-color: #60a5fa; /* Tailwind blue-400 */
        }

        /* Improved focus state */
        .option-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.35);
            border-color: #93c5fd;
        }

        .correct {
            background-color: #166534 !important; /* Tailwind green-700 */
            color: #d1fae5 !important;
            border-color: #10b981 !important; /* Tailwind emerald-500 */
        }

        .incorrect {
            /* Neutralize old red styling to avoid misleading users */
            background-color: #232b38 !important;
            color: #e5e7eb !important;
            border-color: #60a5fa !important; /* Tailwind blue-400 */
        }
        
        .disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        /* Neutral highlight for a user's selected (but incorrect) answer */
        .selected-neutral {
            background-color: #232b38 !important;
            color: #e5e7eb !important;
            border-color: #60a5fa !important; /* Tailwind blue-400 */
        }

        /* Leaderboard Modal Styles */
        #leaderboard-modal {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        #leaderboard-content {
            background-color: rgba(26, 30, 34, 0.7);
            border: 1px solid rgba(96, 165, 250, 0.2);
            backdrop-filter: blur(10px) saturate(140%);
            -webkit-backdrop-filter: blur(10px) saturate(140%);
            border-radius: 14px;
        }
        
        /* Utility for the floating leaderboard button */
        .floating-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
            transition: transform 0.2s;
        }
        .floating-button:hover {
            transform: translateY(-1px) scale(1.05);
        }

        /* Brand logo styling */
        #brand {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }
        #quiz-logo, #quiz-logo-svg {
            height: 72px;
            width: auto;
            image-rendering: -webkit-optimize-contrast;
            filter: drop-shadow(0 6px 20px rgba(0,0,0,0.35));
        }
    </style>

    <!-- App Config: set a stable app ID and your Firebase web config -->
    <script>
        // Set a stable app ID so everyone shares the same leaderboard namespace
        window.__app_id = 'figma-dev-mode-quiz';

        // Replace the placeholder values below with your Firebase web app config
        // from Project Settings → Your apps → Web app (</>), then deploy this file.
        window.__firebase_config = JSON.stringify({
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            appId: "YOUR_WEB_APP_ID"
        });
    </script>

    <!-- Firebase SDK Imports (MUST be placed before the main script block) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase objects globally for the main script block
        window.firebase = { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            orderBy, 
            limit,
            serverTimestamp,
            getDoc,
            onAuthStateChanged
        };
    </script>
</head>
<body>

    <!-- Leaderboard Floating Button -->
    <button onclick="showLeaderboard(true)" id="leaderboard-float-btn" class="floating-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-3 rounded-full flex items-center shadow-lg">
        <!-- SVG for Trophy Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1">
            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
            <path d="M4 22h16"></path>
            <path d="M10 14.66V17c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-2.34l-1 1.73a.5.5 0 0 0 .5.75h11a.5.5 0 0 0 .5-.75l-1-1.73V17c0 .55-.45 1-1 1H15c-.55 0-1-.45-1-1v-2.34l-1 1.73a.5.5 0 0 0 .5.75h-3c-.55 0-1-.45-1-1V17"></path>
            <path d="M12 11c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"></path>
        </svg>
        Leaderboard
    </button>
    
    <!-- Main Quiz Container -->
    <div id="quiz-container" class="rounded-xl p-8 space-y-6">
        <div id="brand">
            <!-- Inline SVG logo for crisp scaling -->
            <svg id="quiz-logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256" role="img" aria-label="Figma Quiz logo">
                <!-- Chat bubble outline -->
                <rect x="24" y="36" rx="32" ry="32" width="176" height="136" fill="#ffffff" opacity="0.06"/>
                <path d="M56 28h112a28 28 0 0 1 28 28v64a28 28 0 0 1-28 28h-56l-32 28v-28H56a28 28 0 0 1-28-28V56A28 28 0 0 1 56 28z" fill="none" stroke="#0f172a" stroke-width="16" stroke-linecap="round" stroke-linejoin="round"/>

                <!-- Stylized Q made of colored nodes -->
                <circle cx="100" cy="88" r="22" fill="none" stroke="#0f172a" stroke-width="12"/>
                <circle cx="72" cy="96" r="8" fill="#f59e0b"/>
                <circle cx="100" cy="88" r="7" fill="#3b82f6"/>
                <circle cx="116" cy="104" r="8" fill="#22c55e"/>
                <circle cx="136" cy="120" r="10" fill="#ef4444"/>
                <path d="M123 110 L132 116" stroke="#22c55e" stroke-width="6" stroke-linecap="round"/>
                <path d="M132 116 L136 120" stroke="#ef4444" stroke-width="6" stroke-linecap="round"/>

                <!-- Pen nib with color segments -->
                <path d="M168 62 l22 -22 20 20 -22 22 -8 2 -12 -12z" fill="#0f172a"/>
                <rect x="180" y="28" width="18" height="18" transform="rotate(45 189 37)" fill="#22c55e"/>
                <rect x="194" y="42" width="18" height="18" transform="rotate(45 203 51)" fill="#f59e0b"/>
                <rect x="166" y="42" width="18" height="18" transform="rotate(45 175 51)" fill="#3b82f6"/>
                <circle cx="176" cy="76" r="3.5" fill="#ffffff"/>
            </svg>
        </div>
        <h1 class="text-3xl font-extrabold text-center">
            <span style="background: linear-gradient(90deg, #60a5fa 0%, #34d399 50%, #eab308 100%); -webkit-background-clip: text; background-clip: text; color: transparent;">
                Figma Dev Mode Mastery Quiz
            </span>
        </h1>
        <p id="sub-title" class="text-center text-gray-400">Test your knowledge on the essential developer tool for design handoff.</p>

        <!-- Quiz Display Area -->
        <div id="quiz-content" class="space-y-6">
            <!-- Content loaded by startQuiz() -->
        </div>

        <!-- Feedback & Navigation -->
        <div id="feedback" class="py-4 px-3 rounded-lg text-sm font-medium border hidden"></div>
        <button id="next-button" onclick="nextQuestion()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 transition duration-150" disabled>
            Next Question
        </button>

        <!-- Start Screen / Restart Button -->
        <button id="start-button" onclick="startQuiz()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150">
            Start Quiz
        </button>
    </div>

    <!-- Name Prompt Modal (Hidden by default) -->
    <div id="name-modal" class="fixed inset-0 hidden items-center justify-center" style="z-index: 200;">
        <div class="absolute inset-0 bg-black opacity-80"></div>
        <div class="bg-[#1a1e22] rounded-xl p-8 max-w-sm w-full z-10 space-y-4 border border-[#30363d] shadow-2xl">
            <h3 class="text-2xl font-bold text-yellow-400 text-center">Enter Your Name</h3>
            <p class="text-gray-400 text-center">Claim your score on the leaderboard!</p>
            <input type="text" id="engineer-name-input" placeholder="e.g., Ada Lovelace" maxlength="20" class="w-full p-3 rounded-lg bg-[#0d1117] border border-[#30363d] text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button id="submit-score-btn" onclick="submitScore()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition duration-150">
                Submit Score
            </button>
        </div>
    </div>

    <!-- Leaderboard Modal (Hidden by default) -->
    <div id="leaderboard-modal" class="fixed inset-0 hidden items-center justify-center">
        <div id="leaderboard-content" class="rounded-xl p-6 max-w-lg w-full z-10 space-y-4">
            <h3 class="text-3xl font-extrabold text-yellow-400 text-center flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-2.34l-1 1.73a.5.5 0 0 0 .5.75h11a.5.5 0 0 0 .5-.75l-1-1.73V17c0 .55-.45 1-1 1H15c-.55 0-1-.45-1-1v-2.34l-1 1.73a.5.5 0 0 0 .5.75h-3c-.55 0-1-.45-1-1V17"></path><path d="M12 11c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"></path></svg>
                Dev Mode Leaderboard
            </h3>
            <div id="leaderboard-list" class="space-y-2 text-gray-300">
                <p class="text-center text-sm text-gray-500">Loading scores...</p>
            </div>
            <button onclick="showLeaderboard(false)" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg transition duration-150">Close</button>
        </div>
    </div>

    <script>
        // --- Firebase/Firestore Global Setup ---
        let app, db, auth;
        let userId = 'anonymous'; // Default until authenticated
        let userName = 'Anonymous Engineer'; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const LEADERBOARD_PATH = `artifacts/${appId}/public/data/quiz_leaderboard`;
        // Detect placeholder configs and force local leaderboard in that case
        const looksLikePlaceholder = (cfg) => {
            if (!cfg) return true;
            const vals = [cfg.apiKey, cfg.projectId, cfg.appId].map(v => (v || '').toString());
            return vals.some(v => v.includes('YOUR_'));
        };
        const USE_LOCAL_LEADERBOARD = !firebaseConfig || !firebaseConfig.projectId || looksLikePlaceholder(firebaseConfig);

        const quizData = [
            { question: "Question 1/10: What is the primary purpose of Figma's Dev Mode from an engineer's perspective?", options: ["To create and edit design files directly.", "To turn designs into code more efficiently by providing a developer-centric workspace.", "To collaborate with other engineers on coding tasks.", "To manage the project's timeline and budget."], answer: "To turn designs into code more efficiently by providing a developer-centric workspace.", explanation: "Dev Mode is specifically built to streamline the design-to-code handoff by providing specs, code snippets, and a developer-friendly interface." },
            { question: "Question 2/10: What is the keyboard shortcut to quickly toggle between Design Mode and Dev Mode?", options: ["Ctrl + D", "Shift + F", "Shift + D", "Alt + D"], answer: "Shift + D", explanation: "The shortcut 'Shift + D' is the quickest way to enter or exit Dev Mode, saving engineers valuable time." },
            { question: "Question 3/10: What is the main benefit of the 'Ready for development' status in Dev Mode?", options: ["It automatically generates all the code for the design.", "It signals to the engineering team which sections of the design are finalized and ready for implementation.", "It allows engineers to make changes to the design.", "It adds a comment to the design file for the designer."], answer: "It signals to the engineering team which sections of the design are finalized and ready for implementation.", explanation: "This status is a crucial communication tool, creating a single source of truth for work prioritization and avoiding developers implementing incomplete work." },
            { question: "Question 4/10: How can you quickly view the padding and margin of a selected element in Dev Mode?", options: ["Right-click and select 'Show measurements.'", "Hold down the Alt (Option on Mac) key and hover over the element.", "The values are always visible in the inspect panel.", "You have to manually calculate them."], answer: "Hold down the Alt (Option on Mac) key and hover over the element.", explanation: "Holding Alt/Option while hovering is the fastest way to instantly measure distances between layers—a key efficiency trick." },
            { question: "Question 5/10: The inspect panel can provide code snippets in various languages. Which of the following is NOT a language option for code generation in Figma's Dev Mode?", options: ["CSS", "SwiftUI", "Compose (Jetpack Compose)", "Python"], answer: "Python", explanation: "Figma supports front-end development languages like CSS, SwiftUI (for iOS), and Compose (for Android), but not Python for UI output." },
            { question: "Question 6/10: How can an engineer export assets (like icons or images) from a Figma file?", options: ["Select the asset in Dev Mode and use the 'Export' section in the inspect panel.", "You can only export assets if you have a 'Full' seat.", "You have to request the designer to export and send them to you.", "Exporting is not a feature in Dev Mode."], answer: "Select the asset in Dev Mode and use the 'Export' section in the inspect panel.", explanation: "The Export section in the inspect panel allows engineers to download assets in various formats (PNG, SVG, JPG) with specified resolution." },
            { question: "Question 7/10: What is the purpose of the 'Compare changes' feature in Dev Mode?", options: ["It compares the current design with a design from a different file.", "It shows a side-by-side view of the current design and a previous version, highlighting what has been modified.", "It compares the current design to the code you have written.", "It checks for design system inconsistencies."], answer: "It shows a side-by-side view of the current design and a previous version, highlighting what has been modified.", explanation: "This feature is vital for quickly auditing design changes post-handoff, preventing wasted development time on outdated specs." },
            { question: "Question 8/10: Dev Mode allows for integrations with external tools. Which of these is a common integration used to link designs to development tasks?", options: ["Salesforce", "Jira", "Google Docs", "Dropbox"], answer: "Jira", explanation: "Integrations like Jira allow engineers to quickly find the relevant design file from a ticket or link tickets directly to components in Figma." },
            { question: "Question 9/10: What is the Component Playground?", options: ["A game for designers to test their knowledge of components.", "A separate space where developers can experiment with a component's different properties and variable modes without altering the main design.", "A tool for creating new components from scratch.", "A feature that automatically fixes component errors."], answer: "A separate space where developers can experiment with a component's different properties and variable modes without altering the main design.", explanation: "The Component Playground helps engineers understand and test component behavior (variants, props) quickly before coding them." },
            { question: "Question 10/10: True or False: A developer with a View seat has access to all advanced features of Dev Mode, including Compare changes and Add external links.", options: ["True", "False"], answer: "False", explanation: "Full Dev Mode functionality, including 'Compare changes' and Dev resources, requires a paid 'Dev' or 'Full' seat. View seats only get basic inspection." }
        ];

        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;

        const quizContent = document.getElementById('quiz-content');
        const feedbackEl = document.getElementById('feedback');
        const nextButton = document.getElementById('next-button');
        const startButton = document.getElementById('start-button');
        const subTitle = document.getElementById('sub-title');
        const nameModal = document.getElementById('name-modal');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const engineerNameInput = document.getElementById('engineer-name-input');
        const leaderboardList = document.getElementById('leaderboard-list');

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                if (USE_LOCAL_LEADERBOARD || !window.firebase) {
                    // Local preview mode: use localStorage-backed leaderboard
                    userId = (localStorage.getItem(`${appId}_uid`) || crypto.randomUUID());
                    localStorage.setItem(`${appId}_uid`, userId);
                    setupLocalLeaderboardListener();
                    return;
                }
                
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined') {
                    await firebase.signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await firebase.signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`Authenticated as User ID: ${userId}`);

                // Load existing name if available
                const userDocRef = firebase.doc(db, LEADERBOARD_PATH, userId);
                const userDoc = await firebase.getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().name) {
                    userName = userDoc.data().name;
                    engineerNameInput.value = userName;
                }
                
                setupLeaderboardListener();

            } catch (error) {
                console.error("Error during Firebase initialization or authentication:", error);
                // Fallback to local leaderboard if Firebase fails at runtime
                try {
                    userId = (localStorage.getItem(`${appId}_uid`) || crypto.randomUUID());
                    localStorage.setItem(`${appId}_uid`, userId);
                    setupLocalLeaderboardListener();
                } catch (e) {
                    console.error('Failed to initialize local leaderboard fallback:', e);
                }
            }
        }

        /**
         * Sets up a real-time listener for the leaderboard.
         */
        function setupLeaderboardListener() {
            if (!db) return;
            const leaderboardQuery = firebase.query(
                firebase.collection(db, LEADERBOARD_PATH),
                firebase.orderBy('score', 'desc'),
                firebase.limit(10)
            );

            firebase.onSnapshot(leaderboardQuery, (snapshot) => {
                let html = '';
                const users = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    users.push({ id: doc.id, name: data.name, score: data.score, timestamp: data.timestamp?.toDate() });
                });

                if (users.length === 0) {
                    html = '<p class="text-center text-sm text-gray-500">No scores posted yet. Be the first!</p>';
                } else {
                    html = users.map((user, index) => `
                        <div class="flex justify-between items-center p-3 rounded-lg ${user.id === userId ? 'bg-blue-900/40 border-blue-500 border' : 'bg-gray-800/50'}">
                            <span class="font-bold text-yellow-500 w-8 text-center">${index + 1}.</span>
                            <span class="flex-grow truncate px-2">${user.name} ${user.id === userId ? '(You)' : ''}</span>
                            <span class="font-extrabold text-xl text-white">${user.score}/10</span>
                        </div>
                    `).join('');
                }
                leaderboardList.innerHTML = html;
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                leaderboardList.innerHTML = '<p class="text-center text-red-400">Error loading leaderboard.</p>';
            });
        }

        /**
         * Local fallback: uses localStorage for preview/demo when Firebase config is missing.
         */
        function setupLocalLeaderboardListener() {
            // Render now and on storage changes (other tabs)
            renderLocalLeaderboard();
            window.addEventListener('storage', (e) => {
                if (e.key === `${appId}_local_leaderboard`) renderLocalLeaderboard();
            });
        }

        // Renders local leaderboard from localStorage
        function renderLocalLeaderboard() {
            const raw = localStorage.getItem(`${appId}_local_leaderboard`) || '[]';
            let users;
            try {
                users = JSON.parse(raw);
                if (!Array.isArray(users)) users = [];
            } catch (_) {
                users = [];
            }
            users = users
                .sort((a, b) => (b.score || 0) - (a.score || 0))
                .slice(0, 10);

            if (users.length === 0) {
                leaderboardList.innerHTML = '<p class="text-center text-sm text-gray-500">No scores posted yet. Be the first!</p>';
                return;
            }

            let html = users.map((user, index) => `
                <div class="flex justify-between items-center p-3 rounded-lg ${user.id === userId ? 'bg-blue-900/40 border-blue-500 border' : 'bg-gray-800/50'}">
                    <span class="font-bold text-yellow-500 w-8 text-center">${index + 1}.</span>
                    <span class="flex-grow truncate px-2">${user.name} ${user.id === userId ? '(You)' : ''}</span>
                    <span class="font-extrabold text-xl text-white">${user.score}/10</span>
                </div>
            `).join('');
            leaderboardList.innerHTML = html;
        }

        /**
         * Clears the current content and displays the welcome screen.
         */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            answered = false;

            startButton.textContent = 'Restart Quiz';
            startButton.classList.add('hidden');
            nextButton.classList.add('hidden');
            feedbackEl.classList.add('hidden');
            subTitle.textContent = 'Find out if you are a Figma Dev Mode Master! Good luck.';

            renderQuestion();
        }

        /**
         * Renders the current question and its options to the DOM.
         */
        function renderQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                showResults();
                return;
            }

            const qData = quizData[currentQuestionIndex];
            answered = false;
            nextButton.disabled = true;
            nextButton.classList.add('hidden');
            feedbackEl.classList.add('hidden');
            
            let html = `
                <div id="question-text" class="text-xl font-bold mb-4 text-blue-300">
                    ${qData.question}
                </div>
                <div id="options-container" class="space-y-3">
            `;

            qData.options.forEach((option, index) => {
                html += `
                    <button class="option-button w-full bg-gray-700/50 text-left p-4 hover:bg-gray-600/70" 
                            onclick="checkAnswer(this, '${option.replace(/'/g, "\\'")}')">
                        <span class="font-mono text-blue-400 mr-2">${String.fromCharCode(65 + index)}.</span> ${option}
                    </button>
                `;
            });

            html += `</div>`;
            quizContent.innerHTML = html;
        }

        /**
         * Checks the user's selected answer against the correct answer.
         */
        function checkAnswer(selectedButton, selectedAnswer) {
            if (answered) return;
            answered = true;

            const qData = quizData[currentQuestionIndex];
            const isCorrect = selectedAnswer === qData.answer;

            // Apply styling
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.add('disabled');
                const btnText = btn.textContent.substring(4).trim();
                
                if (btnText === qData.answer) {
                    btn.classList.add('correct');
                } else if (btn === selectedButton) {
                    btn.classList.add('selected-neutral');
                }
            });

            // Update score and show feedback
            if (isCorrect) {
                score++;
                feedbackEl.innerHTML = `<span class="font-bold text-green-400">Correct!</span> ${qData.explanation}`;
                feedbackEl.classList.remove('bg-red-900/30', 'border-red-600/50');
                feedbackEl.classList.add('bg-green-900/30', 'border-green-600/50');
            } else {
                feedbackEl.innerHTML = `<span class="font-bold text-red-400">Incorrect.</span> Correct answer: <span class="font-semibold text-white">${qData.answer}</span>. ${qData.explanation}`;
                feedbackEl.classList.remove('bg-green-900/30', 'border-green-600/50');
                feedbackEl.classList.add('bg-red-900/30', 'border-red-600/50');
            }

            feedbackEl.classList.remove('hidden');
            nextButton.disabled = false;
            nextButton.classList.remove('hidden');
        }

        /**
         * Advances to the next question.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            renderQuestion();
        }

        /**
         * Displays the final results screen and prompts for name.
         */
        function showResults() {
            const total = quizData.length;
            const percentage = (score / total) * 100;
            let resultText = '';
            let color = 'text-yellow-400';
            let icon = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-yellow-400"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>`; // Lucide Code
            
            if (percentage === 100) {
                resultText = "Figma Dev Mode Master! Your knowledge is flawless. You are ready to lead the charge on design handoff best practices.";
                color = 'text-green-400';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-green-400"><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>`; // Lucide CheckCircle
            } else if (percentage >= 70) {
                resultText = "Solid Dev Mode User. You've mastered the core features. Focus on advanced tools like 'Compare changes' and the 'Component Playground' to reach the next level.";
            } else if (percentage >= 50) {
                resultText = "Good Foundations. You understand the basics, but there are some critical time-saving features you're missing. Our workshop will help fill those gaps!";
            } else {
                resultText = "Opportunity to Grow. Let's dive deep into Dev Mode. A better understanding of this tool will dramatically increase your efficiency in implementation.";
                color = 'text-red-400';
                icon = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-400"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`; // Lucide AlertCircle
            }

            quizContent.innerHTML = `
                <div class="text-center space-y-4">
                    ${icon}
                    <h2 class="text-4xl font-extrabold ${color}">Quiz Complete!</h2>
                    <p class="text-2xl font-bold text-white">Final Score: ${score} out of ${total}</p>
                    <div class="text-lg py-4 px-6 rounded-xl border border-gray-600 bg-gray-800 text-gray-200">
                        ${resultText}
                    </div>
                </div>
            `;
            
            nextButton.classList.add('hidden');
            feedbackEl.classList.add('hidden');
            startButton.classList.remove('hidden');
            startButton.textContent = 'Try Again';
            subTitle.textContent = `You scored ${score} out of ${total}. Well done!`;
            
            // Show name prompt modal
            showNamePrompt();
        }
        
        /**
         * Shows the modal for the user to enter their name.
         */
        function showNamePrompt() {
            if (userName !== 'Anonymous Engineer') {
                engineerNameInput.value = userName;
            }
            nameModal.classList.remove('hidden');
            nameModal.classList.add('flex');
        }

        /**
         * Saves the user's score to Firestore.
         */
        async function submitScore() {
            const enteredName = engineerNameInput.value.trim() || 'Anonymous Engineer';
            const finalScore = score;
            
            userName = enteredName.substring(0, 20); // Truncate name to 20 chars
            
            if ((!db || !userId) && !USE_LOCAL_LEADERBOARD) {
                console.error("Database not initialized or user ID missing.");
                // Fallback UI to close modal
                nameModal.classList.remove('flex');
                nameModal.classList.add('hidden');
                return;
            }

            try {
                if (USE_LOCAL_LEADERBOARD) {
                    const key = `${appId}_local_leaderboard`;
                    const raw = localStorage.getItem(key) || '[]';
                    const list = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : [];
                    const idx = list.findIndex((u) => u.id === userId);
                    if (idx >= 0) {
                        const existingScore = list[idx].score || 0;
                        if (finalScore > existingScore) {
                            list[idx] = { id: userId, name: userName, score: finalScore, timestamp: Date.now() };
                        }
                    } else {
                        list.push({ id: userId, name: userName, score: finalScore, timestamp: Date.now() });
                    }
                    // Keep only top 10 by score desc
                    list.sort((a, b) => (b.score || 0) - (a.score || 0));
                    const top10 = list.slice(0, 10);
                    localStorage.setItem(key, JSON.stringify(top10));
                    // Immediately refresh local leaderboard UI
                    renderLocalLeaderboard();
                } else {
                    // Check if user has a higher existing score (Firestore)
                    const userDocRef = firebase.doc(db, LEADERBOARD_PATH, userId);
                    const userDoc = await firebase.getDoc(userDocRef);

                    let shouldUpdate = true;
                    if (userDoc.exists()) {
                        const existingScore = userDoc.data().score || 0;
                        if (finalScore <= existingScore) {
                            shouldUpdate = false;
                        }
                    }

                    if (shouldUpdate) {
                        await firebase.setDoc(userDocRef, {
                            name: userName,
                            score: finalScore,
                            timestamp: firebase.serverTimestamp(),
                            userId: userId,
                        }, { merge: true });
                        console.log(`Score ${finalScore} submitted for user ${userId}.`);
                    } else {
                        console.log(`New score ${finalScore} is not higher than existing score.`);
                    }
                }
               
            } catch (error) {
                console.error("Error submitting score:", error);
            } finally {
                nameModal.classList.remove('flex');
                nameModal.classList.add('hidden');
                showLeaderboard(true); // Show leaderboard immediately after submitting
            }
        }
        
        /**
         * Toggles the visibility of the leaderboard modal.
         * @param {boolean} show - Whether to show (true) or hide (false) the modal.
         */
        function showLeaderboard(show) {
            if (show) {
                leaderboardModal.classList.remove('hidden');
                leaderboardModal.classList.add('flex');
            } else {
                leaderboardModal.classList.remove('flex');
                leaderboardModal.classList.add('hidden');
            }
        }

        // Initial setup on load
        document.addEventListener('DOMContentLoaded', async () => {
            // Display initial welcome screen with playful illustration/icon
            quizContent.innerHTML = `
                <div class="text-center space-y-6 py-8">
                    <!-- Playful Illustration (Lucide Code) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto"><path d="m18 16 4-4-4-4"></path><path d="m6 8-4 4 4 4"></path><path d="m14.5 4-5 16"></path></svg>
                    <p class="text-lg text-gray-300 font-semibold">Dev Mode: Bridging Design and Code.</p>
                    <p class="text-md text-gray-400">Ready to find out how well you utilize the most powerful tool for design handoff?</p>
                </div>
            `;
            
            nextButton.classList.add('hidden');
            
            // Initialize Firebase services
            await initFirebase();
        });

    </script>
</body>
</html>


