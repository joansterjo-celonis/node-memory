<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Approval Analysis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @keyframes slide-in-from-bottom-4 {
      from {
        opacity: 0;
        transform: translateY(1rem);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .animate-in {
      animation: slide-in-from-bottom-4 0.5s ease-out;
    }
    .fill-mode-backwards {
      animation-fill-mode: backwards;
    }
    .scrollbar-thin {
      scrollbar-width: thin;
    }
    .scrollbar-thumb-gray-200::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thumb-gray-200::-webkit-scrollbar-thumb {
      background-color: #e5e7eb;
      border-radius: 3px;
    }
    .progress-bar {
      position: relative;
      height: 8px;
      background: #dbeafe;
      border-radius: 9999px;
      overflow: hidden;
    }
    .progress-bar::after {
      content: '';
      position: absolute;
      left: -40%;
      top: 0;
      bottom: 0;
      width: 40%;
      background: #3b82f6;
      animation: progress-indeterminate 1s linear infinite;
    }
    @keyframes progress-indeterminate {
      0% { left: -40%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;
    const { createElement: h } = React;

    // ----------------------------
    // Model / Utilities
    // ----------------------------

    // Icon components using inline SVG
    const createIcon = (paths) => (props) => {
      const size = props.size || 24;
      const strokeWidth = props.strokeWidth || 2;
      const className = props.className || '';
      return h('svg', {
        width: size,
        height: size,
        viewBox: '0 0 24 24',
        fill: 'none',
        stroke: 'currentColor',
        strokeWidth: strokeWidth,
        strokeLinecap: 'round',
        strokeLinejoin: 'round',
        className: className,
        ...props
      }, Array.isArray(paths) ? paths.map((path, i) => 
        h('path', { key: i, d: path })
      ) : h('path', { d: paths }));
    };

    const Plus = createIcon('M5 12h14M12 5v14');
    const Filter = createIcon(['M22 3H2l8 9.46V19l4 2v-8.54L22 3z']);
    const BarChart3 = createIcon(['M3 3v18h18', 'M18 17V9', 'M13 17V5', 'M8 17v-3']);
    const Database = createIcon(['M21 5c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2s.9-2 2-2h14c1.1 0 2 .9 2 2z', 'M21 12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2s.9-2 2-2h14c1.1 0 2 .9 2 2z', 'M21 19c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2s.9-2 2-2h14c1.1 0 2 .9 2 2z']);
    const ArrowDown = createIcon('M12 5v14M19 12l-7 7-7-7');
    const Trash2 = createIcon(['M3 6h18', 'M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6', 'M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2']);
    const Settings = createIcon(['M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z', 'M9 12a3 3 0 1 0 6 0 3 3 0 1 0-6 0']);
    const TableIcon = createIcon(['M12 3v18', 'M3 12h18', 'M3 3h18v18H3z']);
    const Play = createIcon('M5 3l14 9-14 9V3z');
    const Save = createIcon(['M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z', 'M17 21v-8H7v8', 'M7 3v5h8']);
    const MoreHorizontal = createIcon(['M12 12h.01', 'M19 12h.01', 'M5 12h.01']);
    const ChevronRight = createIcon('M9 18l6-6-6-6');
    const ListFilter = createIcon(['M3 6h18', 'M7 12h10', 'M10 18h4']);
    const Sigma = createIcon('M18 7c0 2-2 4-4 4H8M14 7c0-2-2-4-4-4M10 21V3');
    const ArrowUpDown = createIcon(['M21 16V8', 'M18 5l3 3-3 3', 'M3 8v8', 'M6 19l-3-3 3-3']);
    const Layout = createIcon(['M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z', 'M3.27 6.96L12 12.01l8.73-5.05', 'M12 22.08V12']);
    const Undo = createIcon(['M3 7v6h6', 'M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13']);
    const Redo = createIcon(['M21 7v6h-6', 'M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13']);
    const Share2 = createIcon(['M18 8a3 3 0 1 0-2.977-2.63l-4.94 2.47a3 3 0 1 0 0 4.319l4.94 2.47a3 3 0 1 0 .895-1.789l-4.94-2.47a3.027 3.027 0 0 0 0-.74l4.94-2.47C18.456 8.778 18 8.402 18 8z']);
    const FileJson = createIcon(['M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z', 'M14 2v6h6', 'M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1', 'M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1']);
    const X = createIcon('M18 6L6 18M6 6l12 12');

    const readFileAsText = (file) =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
        reader.readAsText(file);
      });

    const readFileAsArrayBuffer = (file) =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });

    const parseCSV = (csvText) => {
      // Minimal CSV parser (handles quoted values + commas). Good enough for most exports.
      const rows = [];
      let row = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < csvText.length; i++) {
        const char = csvText[i];
        const next = csvText[i + 1];

        if (char === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
          continue;
        }

        if (char === '"') {
          inQuotes = !inQuotes;
          continue;
        }

        if (!inQuotes && (char === ',' || char === '\n' || char === '\r')) {
          if (char === '\r' && next === '\n') continue;
          row.push(current);
          current = '';
          if (char === '\n') {
            rows.push(row);
            row = [];
          }
          continue;
        }

        current += char;
      }

      // flush
      row.push(current);
      rows.push(row);

      // drop trailing empty row
      const trimmed = rows.filter(r => r.some(cell => String(cell).trim() !== ''));
      if (trimmed.length === 0) return [];

      const headers = trimmed[0].map(h => String(h || '').trim()).filter(Boolean);
      const out = [];
      for (let i = 1; i < trimmed.length; i++) {
        const r = trimmed[i];
        const obj = {};
        headers.forEach((key, idx) => {
          obj[key] = r[idx] ?? '';
        });
        out.push(obj);
      }
      return out;
    };

    const parseXLSX = (arrayBuffer) => {
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const firstSheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheetName];
      // defval keeps empty cells; raw false gives nicer strings for dates
      return XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false });
    };

    // ----------------------------
    // View Components
    // ----------------------------
    const NodeType = {
      SOURCE: 'SOURCE',
      FILTER: 'FILTER',
      AGGREGATE: 'AGGREGATE',
      SORT: 'SORT',
      LIMIT: 'LIMIT',
      VIZ: 'VIZ'
    };

    /**
     * COMPONENT: Properties Panel
     * Handles configuration for the selected node.
     */
    const PropertiesPanel = ({ node, updateNode, schema, sourceStatus }) => {
      if (!node) return h('div', {
        className: 'h-full flex flex-col items-center justify-center p-6 text-gray-400 text-center bg-white border-l border-gray-200'
      }, [
        h(Settings, { size: 48, className: 'mb-4 opacity-20', key: 'icon' }),
        h('p', { key: 'text' }, 'Select a step in the chain', h('br'), 'to configure its logic.')
      ]);

      const handleChange = (key, value) => {
        updateNode(node.id, { ...node.params, [key]: value });
      };

      return h('div', {
        className: 'h-full flex flex-col bg-white border-l border-gray-200 shadow-xl shadow-gray-200/50 w-80 animate-in slide-in-from-right duration-300'
      }, [
        h('div', {
          key: 'header',
          className: 'p-5 border-b border-gray-100 bg-white'
        }, [
          h('div', {
            key: 'badge',
            className: 'flex items-center gap-2 mb-1'
          }, h('span', {
            className: 'text-xs font-bold uppercase tracking-wider text-blue-600 bg-blue-50 px-2 py-0.5 rounded'
          }, `${node.type} Node`)),
          h('h3', {
            key: 'title',
            className: 'font-bold text-gray-900 text-lg'
          }, node.title),
          h('p', {
            key: 'id',
            className: 'text-xs text-gray-500 mt-1'
          }, `ID: ${node.id.split('-')[1]}`)
        ]),
        h('div', {
          key: 'content',
          className: 'p-5 flex-1 overflow-y-auto space-y-6'
        }, [
          // SOURCE CONFIG
          node.type === 'SOURCE' && h('div', {
            key: 'source-config',
            className: 'space-y-4'
          }, [
            h('div', {
              key: 'upload',
              className: 'space-y-1'
            }, [
              h('label', {
                key: 'label',
                className: 'text-sm font-semibold text-gray-700 block'
              }, 'Upload data (CSV or Excel)'),
              h('input', {
                key: 'input',
                type: 'file',
                accept: '.csv,.xlsx,.xls',
                className: 'block w-full text-sm text-gray-600 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100',
                onChange: (e) => handleChange('__file', e.target.files && e.target.files[0] ? e.target.files[0] : null)
              }),
              h('p', {
                key: 'help',
                className: 'text-xs text-gray-500'
              }, 'Tip: upload replaces the "raw data" feeding the chain.')
            ]),
            h('div', {
              key: 'status',
              className: 'bg-blue-50 p-3 rounded-lg border border-blue-100'
            }, h('div', {
              className: 'flex items-start gap-2'
            }, [
              h(Database, { key: 'icon', size: 16, className: 'text-blue-600 mt-0.5' }),
              h('div', { key: 'text' }, [
                h('p', {
                  key: 'title',
                  className: 'text-xs font-semibold text-blue-900'
                }, sourceStatus?.title || 'Connected'),
                h('p', {
                  key: 'desc',
                  className: 'text-xs text-blue-700 mt-1'
                }, sourceStatus?.detail || `Loaded ${INITIAL_DATA.length} records.`)
              ])
            ]))
          ]),

          // FILTER CONFIG
          node.type === 'FILTER' && h('div', {
            key: 'filter-config',
            className: 'space-y-4'
          }, [
            h('div', {
              key: 'field-select',
              className: 'space-y-1'
            }, [
              h('label', {
                key: 'label',
                className: 'text-sm font-semibold text-gray-700 block'
              }, 'Filter Field'),
              h('select', {
                key: 'select',
                className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                value: node.params.field || '',
                onChange: (e) => handleChange('field', e.target.value)
              }, [
                h('option', { key: 'empty', value: '' }, 'Select Field...'),
                ...schema.map(f => h('option', { key: f, value: f }, f))
              ])
            ]),
            h('div', {
              key: 'operator-value',
              className: 'grid grid-cols-3 gap-2'
            }, [
              h('div', {
                key: 'operator',
                className: 'col-span-1 space-y-1'
              }, [
                h('label', {
                  key: 'label',
                  className: 'text-sm font-semibold text-gray-700 block'
                }, 'Operator'),
                h('select', {
                  key: 'select',
                  className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                  value: node.params.operator || 'equals',
                  onChange: (e) => handleChange('operator', e.target.value)
                }, [
                  h('option', { key: 'eq', value: 'equals' }, '='),
                  h('option', { key: 'ne', value: 'not_equals' }, '!='),
                  h('option', { key: 'gt', value: 'gt' }, '>'),
                  h('option', { key: 'lt', value: 'lt' }, '<'),
                  h('option', { key: 'contains', value: 'contains' }, 'Like')
                ])
              ]),
              h('div', {
                key: 'value',
                className: 'col-span-2 space-y-1'
              }, [
                h('label', {
                  key: 'label',
                  className: 'text-sm font-semibold text-gray-700 block'
                }, 'Value'),
                h('input', {
                  key: 'input',
                  type: 'text',
                  className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                  placeholder: 'e.g. Siemens',
                  value: node.params.value || '',
                  onChange: (e) => handleChange('value', e.target.value)
                })
              ])
            ]),
            h('p', {
              key: 'note',
              className: 'text-xs text-gray-500 italic'
            }, 'Case sensitive for this prototype.')
          ]),

          // AGGREGATE CONFIG
          node.type === 'AGGREGATE' && h('div', {
            key: 'aggregate-config',
            className: 'space-y-5'
          }, [
            h('div', {
              key: 'groupby',
              className: 'space-y-1'
            }, [
              h('label', {
                key: 'label',
                className: 'text-sm font-semibold text-gray-700 block'
              }, 'Group By (Dimension)'),
              h('select', {
                key: 'select',
                className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                value: node.params.groupBy || '',
                onChange: (e) => handleChange('groupBy', e.target.value)
              }, [
                h('option', { key: 'empty', value: '' }, 'Select Dimension...'),
                ...schema.map(f => h('option', { key: f, value: f }, f))
              ])
            ]),
            h('div', {
              key: 'aggregation',
              className: 'border-t border-gray-100 pt-4 space-y-4'
            }, [
              h('div', {
                key: 'fn-select',
                className: 'space-y-1'
              }, [
                h('label', {
                  key: 'label',
                  className: 'text-sm font-semibold text-gray-700 block'
                }, 'Aggregation Function'),
                h('div', {
                  key: 'buttons',
                  className: 'flex bg-gray-100 p-1 rounded-lg'
                }, ['count', 'sum', 'avg'].map((fn) => h('button', {
                  key: fn,
                  onClick: () => handleChange('fn', fn),
                  className: `flex-1 py-1.5 text-xs font-medium rounded-md capitalize transition-all ${node.params.fn === fn ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`
                }, fn)))
              ]),
              node.params.fn !== 'count' && h('div', {
                key: 'metric-field',
                className: 'space-y-1 animate-in fade-in slide-in-from-top-1'
              }, [
                h('label', {
                  key: 'label',
                  className: 'text-sm font-semibold text-gray-700 block'
                }, 'Metric Field'),
                h('select', {
                  key: 'select',
                  className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                  value: node.params.metricField || '',
                  onChange: (e) => handleChange('metricField', e.target.value)
                }, [
                  h('option', { key: 'empty', value: '' }, 'Select Numeric Field...'),
                  ...schema.map(f => h('option', { key: f, value: f }, f))
                ])
              ])
            ])
          ]),

          // VIZ CONFIG
          node.type === 'VIZ' && h('div', {
            key: 'viz-config',
            className: 'space-y-5'
          }, [
            h('div', {
              key: 'chart-type',
              className: 'space-y-1'
            }, [
              h('label', {
                key: 'label',
                className: 'text-sm font-semibold text-gray-700 block'
              }, 'Visualization Type'),
              h('div', {
                key: 'buttons',
                className: 'grid grid-cols-2 gap-3'
              }, [
                h('button', {
                  key: 'bar',
                  onClick: () => handleChange('chartType', 'bar'),
                  className: `p-3 border rounded-lg flex flex-col items-center justify-center gap-2 text-sm transition-all ${node.params.chartType === 'bar' ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50 hover:border-gray-300'}`
                }, [
                  h(BarChart3, { key: 'icon', size: 20 }),
                  h('span', { key: 'text', className: 'font-medium' }, 'Bar Chart')
                ]),
                h('button', {
                  key: 'table',
                  onClick: () => handleChange('chartType', 'table'),
                  className: `p-3 border rounded-lg flex flex-col items-center justify-center gap-2 text-sm transition-all ${node.params.chartType === 'table' ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50 hover:border-gray-300'}`
                }, [
                  h(TableIcon, { key: 'icon', size: 20 }),
                  h('span', { key: 'text', className: 'font-medium' }, 'Data Table')
                ])
              ])
            ]),
            node.params.chartType !== 'table' && h('div', {
              key: 'axes',
              className: 'space-y-4 pt-2 border-t border-gray-100'
            }, [
              h('div', {
                key: 'x-axis',
                className: 'space-y-1'
              }, [
                h('label', {
                  key: 'label',
                  className: 'text-sm font-semibold text-gray-700 block'
                }, 'X Axis (Category)'),
                h('select', {
                  key: 'select',
                  className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                  value: node.params.xAxis || '',
                  onChange: (e) => handleChange('xAxis', e.target.value)
                }, [
                  h('option', { key: 'auto', value: '' }, 'Auto Select'),
                  ...schema.map(f => h('option', { key: f, value: f }, f))
                ])
              ]),
              h('div', {
                key: 'y-axis',
                className: 'space-y-1'
              }, [
                h('label', {
                  key: 'label',
                  className: 'text-sm font-semibold text-gray-700 block'
                }, 'Y Axis (Value)'),
                h('select', {
                  key: 'select',
                  className: 'w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none',
                  value: node.params.yAxis || '',
                  onChange: (e) => handleChange('yAxis', e.target.value)
                }, [
                  h('option', { key: 'auto', value: '' }, 'Auto Select'),
                  ...schema.map(f => h('option', { key: f, value: f }, f))
                ])
              ]),
              h('div', {
                key: 'tip',
                className: 'p-3 bg-blue-50 rounded border border-blue-100 text-xs text-blue-800'
              }, h('p', null, h('strong', null, 'Tip:'), ' Click on any bar in the chart to instantly add a filter step for that selection.'))
            ])
          ])
        ].filter(Boolean)),
        h('div', {
          key: 'footer',
          className: 'p-4 bg-gray-50 border-t border-gray-200'
        }, h('div', {
          className: 'flex items-center gap-2 text-xs text-gray-500'
        }, [
          h('div', {
            key: 'dot',
            className: 'w-2 h-2 rounded-full bg-green-500 animate-pulse'
          }),
          h('span', { key: 'text' }, 'Changes autosaved to chain')
        ]))
      ]);
    };

    /**
     * MAIN APP COMPONENT
     */
    const AnalysisApp = () => {
      // --- MODEL STATE ---
      const [rawData, setRawData] = useState([]);
      const [rawDataName, setRawDataName] = useState(null);
      const [loadError, setLoadError] = useState(null);
      const [isLoadingFile, setIsLoadingFile] = useState(false);

      // --- STATE ---
      const [nodes, setNodes] = useState([
        { id: 'node-start', type: 'SOURCE', title: 'Load Raw Data', description: 'Upload dataset', params: { __file: null } }
      ]);
      const [selectedNodeId, setSelectedNodeId] = useState('node-start');
      const [activeAddMenuIndex, setActiveAddMenuIndex] = useState(null);

      // Handle upload when SOURCE node file changes
      const sourceNode = nodes.find(n => n.type === 'SOURCE');
      const sourceFile = sourceNode?.params?.__file || null;
      React.useEffect(() => {
        let cancelled = false;
        const run = async () => {
          if (!sourceFile) return;
          setLoadError(null);
          setIsLoadingFile(true);
          try {
            const name = sourceFile.name || 'Uploaded file';
            const lower = name.toLowerCase();
            let data = [];
            if (lower.endsWith('.csv')) {
              const text = await readFileAsText(sourceFile);
              data = parseCSV(text);
            } else if (lower.endsWith('.xlsx') || lower.endsWith('.xls')) {
              const buf = await readFileAsArrayBuffer(sourceFile);
              data = parseXLSX(buf);
            } else {
              throw new Error('Unsupported file type. Please upload CSV or XLSX.');
            }

            if (!Array.isArray(data) || data.length === 0) {
              throw new Error('No rows found in file.');
            }

            if (!cancelled) {
              setRawData(data);
              setRawDataName(name);
              // keep selected node on source so user can configure
              setSelectedNodeId('node-start');
            }
          } catch (err) {
            if (!cancelled) setLoadError(err?.message || String(err));
          } finally {
            if (!cancelled) setIsLoadingFile(false);
          }
        };
        run();
        return () => { cancelled = true; };
      }, [sourceFile]);

      // --- ENGINE ---
      const chainData = useMemo(() => {
        let currentData = Array.isArray(rawData) ? [...rawData] : [];
        const results = [];

        for (const node of nodes) {
          // 1. Source (Reset/Load)
          if (node.type === 'SOURCE') {
            currentData = Array.isArray(rawData) ? [...rawData] : [];
          }
          // 2. Filter
          else if (node.type === 'FILTER' && node.params.field) {
            currentData = currentData.filter(item => {
              const val = item[node.params.field];
              const filterVal = node.params.value;
              
              if (!filterVal && filterVal !== 0) return true;
              
              // Simple type coercion
              if (node.params.operator === 'equals') return String(val) == String(filterVal);
              if (node.params.operator === 'not_equals') return String(val) != String(filterVal);
              if (node.params.operator === 'gt') return val > Number(filterVal);
              if (node.params.operator === 'lt') return val < Number(filterVal);
              if (node.params.operator === 'contains') return String(val).toLowerCase().includes(String(filterVal).toLowerCase());
              return true;
            });
          }
          // 3. Aggregate
          else if (node.type === 'AGGREGATE' && node.params.groupBy) {
            const groups = {};
            currentData.forEach(item => {
              const key = item[node.params.groupBy];
              if (!groups[key]) groups[key] = { [node.params.groupBy]: key, _count: 0, _sum: 0, _raw: [] };
              groups[key]._count++;
              groups[key]._raw.push(item);
              if (node.params.metricField) {
                groups[key]._sum += (Number(item[node.params.metricField]) || 0);
              }
            });

            currentData = Object.values(groups).map((g) => {
              const res = { [node.params.groupBy]: g[node.params.groupBy] };
              if (node.params.fn === 'sum') res[node.params.metricField] = g._sum;
              else if (node.params.fn === 'avg') res[node.params.metricField] = Math.round(g._sum / g._count);
              else res['Record Count'] = g._count;
              return res;
            });
          }

          results.push({
            nodeId: node.id,
            data: [...currentData],
            schema: currentData.length > 0 ? Object.keys(currentData[0]) : []
          });
        }

        return results;
      }, [nodes]);

      // --- ACTIONS ---
      const addNode = (type, insertIndex, initialParams = {}) => {
        const newId = `node-${Date.now()}`;
        let title = 'New Step';
        let params = { ...initialParams };
        let description = '';

        switch(type) {
          case 'FILTER': 
            title = 'Filter Data'; 
            description = 'Exclude records';
            params = { operator: 'equals', ...initialParams }; 
            break;
          case 'AGGREGATE': 
            title = 'Group & Aggregate'; 
            description = 'Summarize dimensions';
            params = { fn: 'count', ...initialParams }; 
            break;
          case 'VIZ': 
            title = 'Visualization'; 
            description = 'Chart or Table';
            params = { chartType: 'bar', ...initialParams }; 
            break;
        }

        setNodes(prev => {
          const newNodes = [...prev];
          if (typeof insertIndex === 'number') {
            newNodes.splice(insertIndex, 0, { id: newId, type, title, description, params });
            return newNodes;
          }
          return [...prev, { id: newId, type, title, description, params }];
        });
        
        setSelectedNodeId(newId);
        setActiveAddMenuIndex(null);
      };

      const removeNode = (id) => {
        setNodes(prev => prev.filter(n => n.id !== id));
        if (selectedNodeId === id) setSelectedNodeId('node-start');
      };

      const updateNode = (id, params) => {
        setNodes(prev => prev.map(n => n.id === id ? { ...n, params } : n));
      };

      const handleChartDrillDown = (data, nodeIndex, xAxisField) => {
        if (!data || !data.activePayload) return;
        const payload = data.activePayload[0].payload;
        const value = payload[xAxisField];

        // Insert a new Filter node right after the current visualization
        addNode('FILTER', nodeIndex + 1, {
          field: xAxisField,
          operator: 'equals',
          value: value
        });
      };

      const getNodeResult = (id) => chainData.find(r => r.nodeId === id);

      // Simple chart component since Recharts CDN might not work perfectly
      const SimpleBarChart = ({ data, xAxis, yAxis, onClick }) => {
        const maxValue = Math.max(...data.map(d => d[yAxis] || 0));
        const barWidth = 40;
        const chartHeight = 200;
        const chartWidth = 600;
        const padding = 40;

        return h('svg', {
          width: chartWidth,
          height: chartHeight,
          className: 'cursor-pointer',
          onClick: onClick
        }, [
          ...data.map((entry, i) => {
            const x = padding + (i * (chartWidth - 2 * padding) / data.length);
            const barHeight = ((entry[yAxis] || 0) / maxValue) * (chartHeight - 2 * padding);
            const y = chartHeight - padding - barHeight;
            return h('rect', {
              key: i,
              x: x - barWidth / 2,
              y: y,
              width: barWidth,
              height: barHeight,
              fill: '#3B82F6',
              className: 'hover:opacity-80 transition-opacity',
              onClick: () => onClick && onClick({ activePayload: [{ payload: entry }] })
            });
          }),
          ...data.map((entry, i) => {
            const x = padding + (i * (chartWidth - 2 * padding) / data.length);
            return h('text', {
              key: `label-${i}`,
              x: x,
              y: chartHeight - 10,
              textAnchor: 'middle',
              fontSize: 11,
              fill: '#64748B'
            }, String(entry[xAxis]).substring(0, 10));
          })
        ]);
      };

      return h('div', {
        className: 'flex h-screen w-full bg-slate-50 font-sans text-slate-900 overflow-hidden'
      }, [
        // 1. LEFT SIDEBAR
        h('div', {
          key: 'sidebar',
          className: 'w-16 flex-shrink-0 bg-slate-900 flex flex-col items-center py-6 gap-6 text-slate-400 border-r border-slate-800 z-30'
        }, [
          h('div', {
            key: 'logo',
            className: 'w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-blue-900/50 mb-4 ring-1 ring-white/10'
          }, h(Layout, { size: 20 })),
          h('div', {
            key: 'db',
            className: 'p-2.5 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-colors text-white relative group',
            title: 'Data Assets'
          }, h(Database, { size: 20 })),
          h('div', {
            key: 'saved',
            className: 'p-2.5 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors relative group',
            title: 'Saved Analysis'
          }, h(FileJson, { size: 20 })),
          h('div', {
            key: 'settings',
            className: 'mt-auto p-2.5 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors relative group'
          }, h(Settings, { size: 20 }))
        ]),

        // 2. MAIN CANVAS AREA
        h('div', {
          key: 'main',
          className: 'flex-1 flex flex-col relative overflow-hidden bg-[#F8FAFC]'
        }, [
          // Header
          h('header', {
            key: 'header',
            className: 'h-16 bg-white border-b border-gray-200 flex items-center px-8 justify-between shadow-sm z-20'
          }, [
            h('div', {
              key: 'title-section',
              className: 'flex items-center gap-4'
            }, h('div', null, [
              h('h1', {
                key: 'title',
                className: 'font-bold text-gray-900 text-lg leading-tight'
              }, 'Invoice Approval Analysis'),
              h('div', {
                key: 'meta',
                className: 'flex items-center gap-2 text-xs text-gray-500'
              }, [
                h('span', { key: 'time' }, 'Last edited just now'),
                h('span', { key: 'dot', className: 'w-1 h-1 bg-gray-300 rounded-full' }),
                h('span', { key: 'badge', className: 'bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-medium' }, rawDataName || 'Draft')
              ])
            ])),
            h('div', {
              key: 'actions',
              className: 'flex items-center gap-3'
            }, [
              h('div', {
                key: 'undo-redo',
                className: 'flex bg-gray-100 rounded-md p-1 mr-2'
              }, [
                h('button', {
                  key: 'undo',
                  className: 'p-1.5 text-gray-500 hover:text-gray-900 hover:bg-white rounded transition-all shadow-sm'
                }, h(Undo, { size: 16 })),
                h('button', {
                  key: 'redo',
                  className: 'p-1.5 text-gray-500 hover:text-gray-900 hover:bg-white rounded transition-all shadow-sm'
                }, h(Redo, { size: 16 }))
              ]),
              h('button', {
                key: 'share',
                className: 'flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 rounded-lg transition-colors shadow-sm'
              }, [h(Share2, { key: 'icon', size: 16 }), ' Share']),
              h('button', {
                key: 'save',
                className: 'flex items-center gap-2 px-5 py-2 text-sm font-medium bg-slate-900 text-white hover:bg-slate-800 rounded-lg shadow-md hover:shadow-lg transition-all'
              }, [h(Save, { key: 'icon', size: 16 }), ' Save Asset'])
            ])
          ]),

          // Canvas Scroll Area
          h('div', {
            key: 'canvas',
            className: 'flex-1 overflow-y-auto p-8 scroll-smooth',
            onClick: () => setActiveAddMenuIndex(null)
          }, h('div', {
            className: 'max-w-4xl mx-auto pb-48'
          }, [
            loadError && h('div', {
              key: 'error',
              className: 'mb-6 rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-800'
            }, [
              h('div', { key: 'title', className: 'font-semibold mb-1' }, 'Upload error'),
              h('div', { key: 'msg' }, loadError)
            ]),
            // THE CHAIN
            h('div', {
              key: 'chain',
              className: 'relative'
            }, [
              // Vertical connecting line
              h('div', {
                key: 'line',
                className: 'absolute left-1/2 -translate-x-1/2 top-12 bottom-12 w-0.5 bg-gray-300 -z-0'
              }),
              ...nodes.map((node, index) => {
                const result = getNodeResult(node.id);
                const isActive = selectedNodeId === node.id;
                const isSource = node.type === 'SOURCE';

                const IconMap = {
                  SOURCE: Database,
                  FILTER: Filter,
                  AGGREGATE: Sigma,
                  SORT: ArrowUpDown,
                  LIMIT: ArrowDown,
                  VIZ: BarChart3
                };
                const Icon = IconMap[node.type] || Database;

                return h('div', {
                  key: node.id,
                  className: 'relative mb-0 group animate-in slide-in-from-bottom-4 duration-500 fill-mode-backwards flex flex-col items-center',
                  style: { animationDelay: `${index * 100}ms` }
                }, [
                  // Node Card
                  h('div', {
                    key: 'card',
                    onClick: (e) => { e.stopPropagation(); setSelectedNodeId(node.id); },
                    className: `relative z-10 w-full max-w-3xl flex flex-col bg-white rounded-2xl border transition-all cursor-pointer overflow-hidden mb-6 ${isActive ? 'border-blue-500 shadow-xl shadow-blue-500/10 ring-1 ring-blue-500' : 'border-gray-200 shadow-sm hover:border-gray-300 hover:shadow-md'}`
                  }, [
                    // Node Header
                    h('div', {
                      key: 'header',
                      className: 'flex items-center p-5 gap-5'
                    }, [
                      h('div', {
                        key: 'icon',
                        className: `w-14 h-14 rounded-xl flex items-center justify-center shrink-0 shadow-sm ${isActive ? 'bg-blue-600 text-white shadow-blue-600/30' : 'bg-white border border-gray-100 text-gray-500 shadow-sm'}`
                      }, h(Icon, { size: 24 })),
                      h('div', {
                        key: 'content',
                        className: 'flex-1 min-w-0'
                      }, [
                        h('div', {
                          key: 'title-row',
                          className: 'flex items-center gap-2 mb-0.5'
                        }, [
                          h('h4', {
                            key: 'title',
                            className: `font-bold text-lg ${isActive ? 'text-gray-900' : 'text-gray-700'}`
                          }, node.title),
                          node.type === 'FILTER' && h('span', {
                            key: 'badge-filter',
                            className: 'bg-orange-100 text-orange-700 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase'
                          }, 'Filter'),
                          node.type === 'AGGREGATE' && h('span', {
                            key: 'badge-agg',
                            className: 'bg-purple-100 text-purple-700 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase'
                          }, 'Transform')
                        ]),
                        h('div', {
                          key: 'description',
                          className: 'text-sm text-gray-500 truncate flex items-center gap-2'
                        },
                          node.type === 'SOURCE'
                            ? h('span', null,
                                'Dataset ',
                                h('span', { className: 'font-mono bg-gray-100 px-1 rounded text-gray-700' }, rawDataName || 'Not loaded'),
                                ' Â· ',
                                h('span', { className: 'font-mono bg-gray-100 px-1 rounded text-gray-700' }, `${Array.isArray(rawData) ? rawData.length : 0} rows`)
                              )
                            : node.type === 'FILTER' && node.params.field 
                            ? h('span', null, 'Keeping only where ', h('span', { className: 'font-mono bg-gray-100 px-1 rounded text-gray-700' }, node.params.field), ` ${node.params.operator} `, h('span', { className: 'font-mono bg-gray-100 px-1 rounded text-gray-700' }, node.params.value || '...'))
                            : node.type === 'AGGREGATE' && node.params.groupBy
                            ? h('span', null, 'Grouping by ', h('span', { className: 'font-mono bg-gray-100 px-1 rounded text-gray-700' }, node.params.groupBy))
                            : h('span', null, node.description || node.type)
                        )
                      ]),
                      h('div', {
                        key: 'actions',
                        className: 'flex items-center gap-4 text-gray-400'
                      }, [
                        h('div', {
                          key: 'count',
                          className: 'text-right hidden group-hover:block transition-all'
                        }, [
                          h('div', { key: 'num', className: 'font-bold text-gray-900 text-sm' }, result?.data.length),
                          h('div', { key: 'label', className: 'text-[10px] uppercase font-medium tracking-wide' }, 'Records')
                        ]),
                        !isSource && h('div', {
                          key: 'delete',
                          className: 'flex items-center border-l border-gray-100 pl-4'
                        }, h('button', {
                          onClick: (e) => { e.stopPropagation(); removeNode(node.id); },
                          className: 'p-2 hover:bg-red-50 hover:text-red-500 rounded-lg transition-colors',
                          title: 'Remove Step'
                        }, h(Trash2, { size: 18 }))),
                        h(ChevronRight, {
                          key: 'chevron',
                          size: 20,
                          className: `transition-transform duration-300 ${isActive ? 'rotate-90 text-blue-500' : 'text-gray-300'}`
                        })
                      ])
                    ]),
                    // Node Preview Area
                    h('div', {
                      key: 'preview',
                      className: `overflow-hidden transition-all duration-300 ease-in-out bg-gray-50/50 ${isActive || node.type === 'VIZ' ? 'max-h-[500px] border-t border-gray-100 opacity-100' : 'max-h-0 opacity-0'}`
                    }, h('div', {
                      className: 'p-5'
                    }, [
                      // Visualization Preview
                      node.type === 'VIZ' && result && h('div', {
                        key: 'viz-preview',
                        className: 'h-72 w-full bg-white rounded-lg border border-gray-200 p-4 shadow-sm'
                      }, node.params.chartType === 'bar' && node.params.xAxis && node.params.yAxis 
                        ? h(SimpleBarChart, {
                            key: 'chart',
                            data: result.data,
                            xAxis: node.params.xAxis,
                            yAxis: node.params.yAxis,
                            onClick: (data) => handleChartDrillDown(data, index, node.params.xAxis)
                          })
                        : node.params.chartType === 'table'
                        ? h('div', {
                            key: 'table',
                            className: 'overflow-auto h-full text-sm scrollbar-thin scrollbar-thumb-gray-200'
                          }, h('table', {
                            className: 'w-full text-left border-collapse'
                          }, [
                            h('thead', {
                              key: 'thead',
                              className: 'bg-gray-50 sticky top-0 z-10'
                            }, h('tr', null, result.schema.map(col => h('th', {
                              key: col,
                              className: 'p-3 font-semibold text-gray-600 border-b border-gray-200 whitespace-nowrap'
                            }, col)))),
                            h('tbody', {
                              key: 'tbody'
                            }, result.data.map((row, i) => h('tr', {
                              key: i,
                              className: 'hover:bg-blue-50/30 border-b border-gray-100 last:border-0 transition-colors'
                            }, result.schema.map(col => h('td', {
                              key: col,
                              className: 'p-3 text-gray-700 whitespace-nowrap'
                            }, row[col])))))
                          ]))
                        : h('div', {
                            key: 'placeholder',
                            className: 'h-full flex flex-col items-center justify-center text-gray-400 gap-3'
                          }, [
                            h('div', {
                              key: 'icon',
                              className: 'w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center'
                            }, h(BarChart3, { size: 32, className: 'opacity-50' })),
                            h('p', {
                              key: 'text',
                              className: 'text-sm font-medium'
                            }, 'Configure axes in settings panel')
                          ])),
                      // Regular Table Preview for Non-VIZ Nodes
                      node.type !== 'VIZ' && result && h('div', {
                        key: 'table-preview',
                        className: 'rounded-lg border border-gray-200 bg-white overflow-hidden shadow-sm'
                      }, [
                        h('div', {
                          key: 'table-wrapper',
                          className: 'overflow-x-auto'
                        }, h('table', {
                          className: 'w-full text-left text-sm'
                        }, [
                          h('thead', {
                            key: 'thead',
                            className: 'bg-gray-50 text-gray-500 border-b border-gray-200'
                          }, h('tr', null, result.schema.slice(0, 6).map(col => h('th', {
                            key: col,
                            className: 'py-2 px-4 font-medium whitespace-nowrap'
                          }, col)))),
                          h('tbody', {
                            key: 'tbody',
                            className: 'text-gray-700'
                          }, result.data.slice(0, 3).map((row, i) => h('tr', {
                            key: i,
                            className: 'border-b border-gray-100 last:border-0 hover:bg-blue-50/50'
                          }, result.schema.slice(0, 6).map(col => h('td', {
                            key: col,
                            className: 'py-2 px-4 whitespace-nowrap'
                          }, row[col])))))
                        ])),
                        result.data.length > 3 && h('div', {
                          key: 'more',
                          className: 'py-2 bg-gray-50 text-center text-xs text-gray-500 border-t border-gray-200'
                        }, `...and ${result.data.length - 3} more rows`)
                      ])
                    ].filter(Boolean)))
                  ]),
                  // INTERSTITIAL ADD BUTTON
                  h('div', {
                    key: 'add-button',
                    className: 'h-10 relative mb-6'
                  }, h('div', {
                    className: 'absolute left-1/2 -translate-x-1/2 z-20'
                  }, [
                    h('button', {
                      key: 'button',
                      onClick: (e) => {
                        e.stopPropagation();
                        setActiveAddMenuIndex(activeAddMenuIndex === index ? null : index);
                      },
                      className: `flex items-center justify-center w-8 h-8 rounded-full shadow-md border-2 border-white transition-all ${activeAddMenuIndex === index ? 'bg-slate-900 text-white scale-110' : 'bg-gray-100 text-gray-400 hover:bg-blue-500 hover:text-white hover:scale-110'}`
                    }, h(Plus, { size: 16, strokeWidth: 3 })),
                    activeAddMenuIndex === index && h('div', {
                      key: 'menu',
                      className: 'absolute top-10 left-4 bg-white rounded-xl shadow-xl shadow-slate-200/50 border border-gray-100 p-2 w-64 animate-in fade-in slide-in-from-top-2 z-50'
                    }, [
                      h('div', {
                        key: 'menu-header',
                        className: 'flex items-center justify-between px-3 py-2'
                      }, [
                        h('span', {
                          key: 'title',
                          className: 'text-xs font-bold text-gray-400 uppercase tracking-wider'
                        }, 'Insert Step'),
                        h('button', {
                          key: 'close',
                          onClick: () => setActiveAddMenuIndex(null),
                          className: 'text-gray-400 hover:text-gray-600'
                        }, h(X, { size: 14 }))
                      ]),
                      h('button', {
                        key: 'filter',
                        onClick: () => addNode('FILTER', index + 1),
                        className: 'w-full text-left px-3 py-3 hover:bg-blue-50 rounded-lg flex items-center gap-3 text-sm text-gray-700 transition-colors group/item'
                      }, [
                        h('div', {
                          key: 'icon',
                          className: 'bg-orange-100 text-orange-600 p-1.5 rounded group-hover/item:bg-orange-200'
                        }, h(Filter, { size: 16 })),
                        h('div', { key: 'text' }, [
                          h('div', { key: 'title', className: 'font-semibold' }, 'Filter'),
                          h('div', { key: 'desc', className: 'text-xs text-gray-500' }, 'Subset rows based on conditions')
                        ])
                      ]),
                      h('button', {
                        key: 'aggregate',
                        onClick: () => addNode('AGGREGATE', index + 1),
                        className: 'w-full text-left px-3 py-3 hover:bg-blue-50 rounded-lg flex items-center gap-3 text-sm text-gray-700 transition-colors group/item'
                      }, [
                        h('div', {
                          key: 'icon',
                          className: 'bg-purple-100 text-purple-600 p-1.5 rounded group-hover/item:bg-purple-200'
                        }, h(Sigma, { size: 16 })),
                        h('div', { key: 'text' }, [
                          h('div', { key: 'title', className: 'font-semibold' }, 'Group & Aggregate'),
                          h('div', { key: 'desc', className: 'text-xs text-gray-500' }, 'Pivot and summarize data')
                        ])
                      ]),
                      h('div', {
                        key: 'divider',
                        className: 'h-px bg-gray-100 my-1'
                      }),
                      h('button', {
                        key: 'viz',
                        onClick: () => addNode('VIZ', index + 1),
                        className: 'w-full text-left px-3 py-3 hover:bg-blue-50 rounded-lg flex items-center gap-3 text-sm text-gray-700 transition-colors group/item'
                      }, [
                        h('div', {
                          key: 'icon',
                          className: 'bg-blue-100 text-blue-600 p-1.5 rounded group-hover/item:bg-blue-200'
                        }, h(BarChart3, { size: 16 })),
                        h('div', { key: 'text' }, [
                          h('div', { key: 'title', className: 'font-semibold' }, 'Visualize'),
                          h('div', { key: 'desc', className: 'text-xs text-gray-500' }, 'Chart or table view')
                        ])
                      ])
                    ])
                  ]))
                ]);
              })
            ])
          ]))
        ]),

        // 3. RIGHT PANEL (Configuration)
        h(PropertiesPanel, {
          key: 'properties',
          node: nodes.find(n => n.id === selectedNodeId),
          updateNode: updateNode,
          schema: getNodeResult(selectedNodeId)?.schema || [],
          sourceStatus: (() => {
            if (isLoadingFile) return { title: 'Loadingâ¦', detail: 'Parsing file and building tableâ¦', loading: true };
            if (loadError) return { title: 'Error', detail: loadError };
            const count = Array.isArray(rawData) ? rawData.length : 0;
            return { title: 'Connected', detail: `${rawDataName || 'Dataset'} loaded with ${count} rows.` };
          })()
        })
      ]);
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(h(AnalysisApp));
  </script>
</body>
</html>