<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Analysis Canvas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Subtle animation helpers */
    @keyframes slide-in-from-bottom-4 {
      from { opacity: 0; transform: translateY(1rem); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: slide-in-from-bottom-4 0.5s ease-out; }
    .fill-mode-backwards { animation-fill-mode: backwards; }

    /* Thin scrollbars for preview tables */
    .scrollbar-thin { scrollbar-width: thin; }
    .scrollbar-thumb-gray-200::-webkit-scrollbar { width: 6px; }
    .scrollbar-thumb-gray-200::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 3px; }

    /* Indeterminate progress bar for ingestion */
    .progress-bar {
      position: relative;
      height: 8px;
      background: #dbeafe;
      border-radius: 9999px;
      overflow: hidden;
    }
    .progress-bar::after {
      content: '';
      position: absolute;
      left: -40%;
      top: 0;
      bottom: 0;
      width: 40%;
      background: #3b82f6;
      animation: progress-indeterminate 1s linear infinite;
    }
    @keyframes progress-indeterminate {
      0% { left: -40%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body>
  <div id="boot-error" style="display:none; padding:12px; margin:12px; border:1px solid #fecaca; background:#fef2f2; color:#991b1b; font-family:system-ui, -apple-system, sans-serif; font-size:12px;"></div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    // ---------------------------------------------------------------------
    // ICONS (inline SVG so this stays fully static and dependency-free)
    // ---------------------------------------------------------------------
    const createIcon = (paths) => (props) => {
      const size = props.size || 24;
      const strokeWidth = props.strokeWidth || 2;
      const className = props.className || '';
      return (
        <svg
          width={size}
          height={size}
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          strokeWidth={strokeWidth}
          strokeLinecap="round"
          strokeLinejoin="round"
          className={className}
        >
          {Array.isArray(paths)
            ? paths.map((d, i) => <path key={i} d={d} />)
            : <path d={paths} />}
        </svg>
      );
    };

    const Plus = createIcon('M5 12h14M12 5v14');
    const Filter = createIcon(['M22 3H2l8 9.46V19l4 2v-8.54L22 3z']);
    const BarChart3 = createIcon(['M3 3v18h18', 'M18 17V9', 'M13 17V5', 'M8 17v-3']);
    const Database = createIcon(['M21 5c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2s.9-2 2-2h14c1.1 0 2 .9 2 2z', 'M21 12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2s.9-2 2-2h14c1.1 0 2 .9 2 2z', 'M21 19c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2s.9-2 2-2h14c1.1 0 2 .9 2 2z']);
    const Trash2 = createIcon(['M3 6h18', 'M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6', 'M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2']);
    const Settings = createIcon(['M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z', 'M9 12a3 3 0 1 0 6 0 3 3 0 1 0-6 0']);
    const TableIcon = createIcon(['M12 3v18', 'M3 12h18', 'M3 3h18v18H3z']);
    const Play = createIcon('M5 3l14 9-14 9V3z');
    const Save = createIcon(['M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z', 'M17 21v-8H7v8', 'M7 3v5h8']);
    const ChevronRight = createIcon('M9 18l6-6-6-6');
    const ChevronDown = createIcon('M6 9l6 6 6-6');
    const ChevronsDown = createIcon('M7 7l5 5 5-5M7 12l5 5 5-5');
    const ChevronsUp = createIcon('M7 17l5-5 5 5M7 12l5-5 5 5');
    const Sigma = createIcon('M18 7c0 2-2 4-4 4H8M14 7c0-2-2-4-4-4M10 21V3');
    const Layout = createIcon(['M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z', 'M3.27 6.96L12 12.01l8.73-5.05', 'M12 22.08V12']);
    const Undo = createIcon(['M3 7v6h6', 'M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13']);
    const Redo = createIcon(['M21 7v6h-6', 'M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13']);
    const Share2 = createIcon(['M18 8a3 3 0 1 0-2.977-2.63l-4.94 2.47a3 3 0 1 0 0 4.319l4.94 2.47a3 3 0 1 0 .895-1.789l-4.94-2.47a3.027 3.027 0 0 0 0-.74l4.94-2.47C18.456 8.778 18 8.402 18 8z']);
    const FileJson = createIcon(['M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z', 'M14 2v6h6', 'M10 12a1 1 0 0 0-1 1v1a1 1 0 0 1-1 1 1 1 0 0 1 1 1v1a1 1 0 0 0 1 1', 'M14 18a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1 1 1 0 0 1-1-1v-1a1 1 0 0 0-1-1']);
    const X = createIcon('M18 6L6 18M6 6l12 12');
    const GitBranch = createIcon(['M6 3v12', 'M18 21v-6', 'M6 15a4 4 0 0 0 4 4h8']);
    const Hash = createIcon(['M4 9h16', 'M4 15h16', 'M10 3L8 21', 'M16 3l-2 18']);
    const TrendingUp = createIcon(['M23 6l-9.5 9.5-5-5L1 18', 'M17 6h6v6']);
    const Gauge = createIcon(['M12 22a8 8 0 1 0-8-8', 'M12 14l3-3']);
    const LinkIcon = createIcon(['M10 13a5 5 0 0 0 7.07 0l1.41-1.41a5 5 0 0 0 0-7.07 5 5 0 0 0-7.07 0L10 6', 'M14 11a5 5 0 0 0-7.07 0L5.52 12.41a5 5 0 0 0 0 7.07 5 5 0 0 0 7.07 0L14 18']);
    const CheckSquare = createIcon(['M9 11l3 3L22 4', 'M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11']);
    const Minimize2 = createIcon(['M4 14h6v6', 'M20 10h-6V4']);

    // ---------------------------------------------------------------------
    // DATA INGESTION (CSV/XLSX) + MODEL STRUCTURE
    // ---------------------------------------------------------------------
    // NOTE: We keep the ingestion pipeline built earlier, but now it fills a
    //       relational-style data model (tables by name) to support JOIN nodes.

    const readFileAsText = (file) =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result || ''));
        reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
        reader.readAsText(file);
      });

    const readFileAsArrayBuffer = (file) =>
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error || new Error('Failed to read file'));
        reader.readAsArrayBuffer(file);
      });

    const parseCSV = (csvText) => {
      // Minimal CSV parser (handles quoted values + commas).
      const text = String(csvText || '').replace(/^\uFEFF/, '');
      const rows = [];
      let row = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];

        if (char === '"' && inQuotes && next === '"') {
          current += '"';
          i++;
          continue;
        }
        if (char === '"') {
          inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && (char === ',' || char === '\n' || char === '\r')) {
          if (char === '\r' && next === '\n') continue;
          row.push(current);
          current = '';
          if (char === '\n') {
            rows.push(row);
            row = [];
          }
          continue;
        }
        current += char;
      }

      row.push(current);
      rows.push(row);

      const trimmed = rows.filter(r => r.some(cell => String(cell).trim() !== ''));
      if (trimmed.length === 0) return [];

      const headers = trimmed[0].map(h => String(h || '').trim()).filter(Boolean);
      const out = [];
      for (let i = 1; i < trimmed.length; i++) {
        const r = trimmed[i];
        const obj = {};
        headers.forEach((key, idx) => {
          obj[key] = r[idx] ?? '';
        });
        out.push(obj);
      }
      return out;
    };

    const parseXLSX = (arrayBuffer) => {
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const tables = {};
      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '', raw: false });
        tables[sheetName] = rows;
      });
      return tables;
    };

    const buildDataModelFromCSV = (fileName, rows) => {
      const name = fileName.replace(/\.(csv)$/i, '') || 'data';
      return { tables: { [name]: rows }, order: [name] };
    };

    const buildDataModelFromXLSX = (tables) => {
      const order = Object.keys(tables);
      return { tables, order };
    };

    // ---------------------------------------------------------------------
    // NODE TYPES + UTILITIES
    // ---------------------------------------------------------------------
    const NodeType = {
      SOURCE: 'SOURCE',
      FILTER: 'FILTER',
      AGGREGATE: 'AGGREGATE',
      SORT: 'SORT',
      LIMIT: 'LIMIT',
      JOIN: 'JOIN',
      COMPONENT: 'COMPONENT'
    };

    const ComponentType = {
      TABLE: 'TABLE',
      CHART: 'CHART',
      KPI: 'KPI',
      GAUGE: 'GAUGE'
    };

    const getChildren = (nodes, parentId) => nodes.filter(n => n.parentId === parentId);

    const countDescendants = (nodes, parentId) => {
      let count = 0;
      const children = getChildren(nodes, parentId);
      count += children.length;
      children.forEach(child => { count += countDescendants(nodes, child.id); });
      return count;
    };

    const getNodeResult = (chainData, id) => chainData.find(r => r.nodeId === id);

    const getCalculationOrder = (nodes) => {
      // Breadth-first ensures parent nodes are processed before children.
      const order = [];
      const queue = nodes.filter(n => n.parentId === null);
      while (queue.length > 0) {
        const current = queue.shift();
        order.push(current);
        const children = getChildren(nodes, current.id);
        queue.push(...children);
      }
      return order;
    };

    const formatNumber = (num) =>
      new Intl.NumberFormat('en-US', { notation: 'compact', maximumFractionDigits: 1 }).format(num);

    const calculateMetric = (data, field, fn) => {
      if (fn === 'count') return data.length;
      if (!field) return 0;
      const values = data.map(d => Number(d[field]) || 0);
      if (fn === 'sum') return values.reduce((a, b) => a + b, 0);
      if (fn === 'avg') return values.reduce((a, b) => a + b, 0) / (values.length || 1);
      return 0;
    };

    // ---------------------------------------------------------------------
    // COMPONENT: Properties Panel (configuration for the selected node)
    // ---------------------------------------------------------------------
    const PropertiesPanel = ({ node, updateNode, schema, dataModel, sourceStatus, onIngest }) => {
      // Local staging for JOIN config (so user can edit multiple fields then commit).
      const [localParams, setLocalParams] = useState({});

      useEffect(() => {
        if (node) setLocalParams(node.params || {});
      }, [node?.id, node?.params]);

      if (!node) {
        return (
    <div className="h-full flex flex-col items-center justify-center p-6 text-gray-400 text-center bg-white border-l border-gray-200">
      <Settings size={48} className="mb-4 opacity-20" />
      <p>Select a step in the chain<br/>to configure its logic.</p>
    </div>
  );
      }

      const handleChange = (key, value) => {
        const newParams = { ...node.params, [key]: value };
        updateNode(node.id, newParams);
        setLocalParams(newParams);
      };

      const handleLocalChange = (key, value) => {
        setLocalParams(prev => ({ ...prev, [key]: value }));
      };

      const commitJoin = () => updateNode(node.id, localParams);
      const handleMetaChange = (key, value) => updateNode(node.id, { [key]: value }, true);

  return (
        <div className="h-full flex flex-col bg-white border-l border-gray-200 shadow-xl shadow-gray-200/50 w-80 animate-in slide-in-from-right duration-300 z-50">
          {/* Header */}
      <div className="p-5 border-b border-gray-100 bg-white">
        <div className="flex items-center gap-2 mb-1">
          <span className="text-xs font-bold uppercase tracking-wider text-blue-600 bg-blue-50 px-2 py-0.5 rounded">
                {node.type === 'COMPONENT' ? node.params.subtype : node.type} Node
          </span>
        </div>
            <input
              type="text"
              value={node.title}
              onChange={(e) => handleMetaChange('title', e.target.value)}
              className="font-bold text-gray-900 text-lg w-full border-none p-0 focus:ring-0 placeholder-gray-400"
            />
            <div className="flex items-center gap-2 mt-2">
              <span className="text-xs text-gray-400 font-mono">ID: {node.id.split('-').pop()}</span>
            </div>
      </div>

          {/* Body */}
      <div className="p-5 flex-1 overflow-y-auto space-y-6">
            {/* Shared: Branch label */}
            <div className="space-y-1">
              <label className="text-xs font-bold text-gray-500 uppercase tracking-wider">Branch Label</label>
              <input
                type="text"
                className="w-full p-2 border border-gray-200 rounded text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                placeholder="e.g. Experiment A"
                value={node.branchName || ''}
                onChange={(e) => handleMetaChange('branchName', e.target.value)}
              />
            </div>

            <div className="h-px bg-gray-100 my-2"></div>
        
        {/* SOURCE CONFIG */}
        {node.type === 'SOURCE' && (
          <div className="space-y-4">
                {/* Table selector (only shows if XLSX has multiple sheets) */}
                {dataModel.order.length > 1 && (
            <div className="space-y-1">
                    <label className="text-sm font-semibold text-gray-700">Table</label>
              <select 
                className="w-full p-2.5 border border-gray-200 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" 
                      value={node.params.table || dataModel.order[0]}
                      onChange={(e) => handleChange('table', e.target.value)}
              >
                      {dataModel.order.map(name => (
                        <option key={name} value={name}>{name}</option>
                      ))}
              </select>
            </div>
                )}

                {/* File ingestion controls */}
                <div className="space-y-1">
                  <label className="text-sm font-semibold text-gray-700 block">Upload data (CSV or Excel)</label>
                  <input
                    type="file"
                    accept=".csv,.xlsx,.xls"
                    className="block w-full text-sm text-gray-600 file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                    onChange={(e) => handleChange('__file', e.target.files && e.target.files[0] ? e.target.files[0] : null)}
                  />
                  <p className="text-xs text-gray-500">Tip: upload replaces the “raw data” feeding the chain.</p>
                </div>

                <button
                  onClick={() => onIngest && onIngest()}
                  disabled={!node.params?.__file || sourceStatus?.loading}
                  className={`w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                    !node.params?.__file || sourceStatus?.loading
                      ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                      : 'bg-blue-600 text-white hover:bg-blue-700'
                  }`}
                >
                  {sourceStatus?.loading ? 'Ingesting…' : 'Ingest Data'}
                </button>

                {/* Status + progress */}
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 space-y-2">
              <div className="flex items-start gap-2">
                <Database size={16} className="text-blue-600 mt-0.5" />
                <div>
                      <p className="text-xs font-semibold text-blue-900">{sourceStatus?.title || 'No dataset loaded'}</p>
                      <p className="text-xs text-blue-700 mt-1">{sourceStatus?.detail || 'Upload a CSV or Excel file to get started.'}</p>
                </div>
              </div>
                  {sourceStatus?.loading && <div className="progress-bar" />}
            </div>
          </div>
        )}

            {/* JOIN CONFIG */}
            {node.type === 'JOIN' && (
              <div className="space-y-5">
                <div className="bg-slate-900 rounded-md p-3 text-xs font-mono text-slate-300 overflow-x-auto border border-slate-800">
                  <span className="text-pink-400">SELECT</span> * <br/>
                  <span className="text-pink-400">FROM</span> [Incoming_Node] <br/>
                  <span className="text-pink-400">{localParams.joinType || 'LEFT'} JOIN</span> {localParams.rightTable || '...'} <br/>
                  <span className="text-pink-400">ON</span> {localParams.leftKey || '?'} = {localParams.rightKey || '?'}
                </div>

                <div className="space-y-1">
                  <label className="text-sm font-semibold text-gray-700 block">Join With Table</label>
                  <select
                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    value={localParams.rightTable || ''}
                    onChange={(e) => handleLocalChange('rightTable', e.target.value)}
                  >
                    <option value="">Select Table...</option>
                    {dataModel.order.map(name => (
                      <option key={name} value={name}>{name}</option>
                    ))}
                  </select>
                </div>

                <div className="space-y-1">
                  <label className="text-sm font-semibold text-gray-700 block">Join Type</label>
                  <div className="grid grid-cols-2 gap-2">
                    {['INNER', 'LEFT', 'RIGHT', 'FULL'].map(t => (
                      <button
                        key={t}
                        onClick={() => handleLocalChange('joinType', t)}
                        className={`text-xs py-2 rounded border transition-all ${localParams.joinType === t ? 'bg-blue-50 border-blue-500 text-blue-700 font-medium' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}
                      >
                        {t} JOIN
                      </button>
                    ))}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-2">
                  <div className="space-y-1">
                    <label className="text-xs font-semibold text-gray-500 block">Left Key</label>
                    <select
                      className="w-full p-2 border border-gray-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 outline-none"
                      value={localParams.leftKey || ''}
                      onChange={(e) => handleLocalChange('leftKey', e.target.value)}
                    >
                      <option value="">Col...</option>
                      {schema.map(f => <option key={f} value={f}>{f}</option>)}
                    </select>
                  </div>
                  <div className="space-y-1">
                    <label className="text-xs font-semibold text-gray-500 block">Right Key</label>
                    <select
                      className="w-full p-2 border border-gray-200 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 outline-none"
                      value={localParams.rightKey || ''}
                      onChange={(e) => handleLocalChange('rightKey', e.target.value)}
                    >
                      <option value="">Col...</option>
                      {(localParams.rightTable && dataModel.tables[localParams.rightTable])
                        ? Object.keys(dataModel.tables[localParams.rightTable][0] || {}).map(f => <option key={f} value={f}>{f}</option>)
                        : null}
                    </select>
                  </div>
                </div>

                <button
                  onClick={commitJoin}
                  className="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg text-sm font-medium transition-colors shadow-sm mt-2"
                >
                  <Play size={16} /> Run Join
                </button>
              </div>
            )}

        {/* FILTER CONFIG */}
        {node.type === 'FILTER' && (
          <div className="space-y-4">
            <div className="space-y-1">
              <label className="text-sm font-semibold text-gray-700 block">Filter Field</label>
              <select 
                className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                value={node.params.field || ''}
                onChange={(e) => handleChange('field', e.target.value)}
              >
                <option value="">Select Field...</option>
                {schema.map(f => <option key={f} value={f}>{f}</option>)}
              </select>
            </div>
            <div className="grid grid-cols-3 gap-2">
              <div className="col-span-1 space-y-1">
                 <label className="text-sm font-semibold text-gray-700 block">Operator</label>
                 <select 
                  className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                  value={node.params.operator || 'equals'}
                  onChange={(e) => handleChange('operator', e.target.value)}
                >
                  <option value="equals">=</option>
                  <option value="not_equals">!=</option>
                  <option value="gt">&gt;</option>
                  <option value="lt">&lt;</option>
                  <option value="contains">Like</option>
                </select>
              </div>
              <div className="col-span-2 space-y-1">
                <label className="text-sm font-semibold text-gray-700 block">Value</label>
                <input 
                  type="text" 
                  className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                      placeholder="Value..."
                  value={node.params.value || ''}
                  onChange={(e) => handleChange('value', e.target.value)}
                />
              </div>
            </div>
          </div>
        )}

        {/* AGGREGATE CONFIG */}
        {node.type === 'AGGREGATE' && (
          <div className="space-y-5">
             <div className="space-y-1">
              <label className="text-sm font-semibold text-gray-700 block">Group By (Dimension)</label>
              <select 
                className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                value={node.params.groupBy || ''}
                onChange={(e) => handleChange('groupBy', e.target.value)}
              >
                <option value="">Select Dimension...</option>
                {schema.map(f => <option key={f} value={f}>{f}</option>)}
              </select>
            </div>
            
            <div className="border-t border-gray-100 pt-4 space-y-4">
              <div className="space-y-1">
                <label className="text-sm font-semibold text-gray-700 block">Aggregation Function</label>
                <div className="flex bg-gray-100 p-1 rounded-lg">
                  {['count', 'sum', 'avg'].map((fn) => (
                    <button
                      key={fn}
                      onClick={() => handleChange('fn', fn)}
                      className={`flex-1 py-1.5 text-xs font-medium rounded-md capitalize transition-all ${node.params.fn === fn ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                      {fn}
                    </button>
                  ))}
                </div>
              </div>

              {node.params.fn !== 'count' && (
                    <div className="space-y-1">
                  <label className="text-sm font-semibold text-gray-700 block">Metric Field</label>
                  <select 
                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    value={node.params.metricField || ''}
                    onChange={(e) => handleChange('metricField', e.target.value)}
                  >
                    <option value="">Select Numeric Field...</option>
                    {schema.map(f => <option key={f} value={f}>{f}</option>)}
                  </select>
                </div>
              )}
            </div>
          </div>
        )}

            {/* COMPONENT CONFIG (TABLE / CHART / KPI / GAUGE) */}
            {node.type === 'COMPONENT' && (
          <div className="space-y-5">
                {/* Table Column Selection */}
                {node.params.subtype === 'TABLE' && (
                  <div className="space-y-3">
                    <label className="text-sm font-semibold text-gray-700 block">Visible Columns</label>
                    <div className="border border-gray-200 rounded-lg max-h-48 overflow-y-auto p-2 bg-gray-50 scrollbar-thin">
                      {schema.map(field => {
                        const isChecked = node.params.columns ? node.params.columns.includes(field) : true;
                        return (
                          <label key={field} className="flex items-center gap-2 text-xs text-gray-700 py-1.5 hover:bg-gray-100 rounded px-1.5 cursor-pointer select-none">
                            <div className={`w-4 h-4 border rounded flex items-center justify-center transition-colors ${isChecked ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-gray-300'}`}>
                              {isChecked && <CheckSquare size={10} />}
                            </div>
                            <input
                              type="checkbox"
                              checked={isChecked}
                              onChange={(e) => {
                                const currentCols = node.params.columns || schema;
                                const newCols = e.target.checked
                                  ? [...currentCols, field]
                                  : currentCols.filter((c) => c !== field);
                                handleChange('columns', newCols);
                              }}
                              className="hidden"
                            />
                            <span className="truncate">{field}</span>
                          </label>
                        );
                      })}
                    </div>
                    <div className="flex justify-between items-center px-1">
                      <button onClick={() => handleChange('columns', schema)} className="text-[10px] font-medium text-blue-600 hover:underline">Select All</button>
                      <button onClick={() => handleChange('columns', [])} className="text-[10px] font-medium text-gray-400 hover:text-gray-600 hover:underline">Clear All</button>
                    </div>
                  </div>
                )}

                {/* Chart Type Selector */}
                {node.params.subtype === 'CHART' && (
             <div className="space-y-1">
                    <label className="text-sm font-semibold text-gray-700 block">Chart Type</label>
              <div className="grid grid-cols-2 gap-3">
                <button 
                  onClick={() => handleChange('chartType', 'bar')}
                        className={`p-2.5 border rounded-lg flex items-center justify-center gap-2 text-sm transition-all ${node.params.chartType === 'bar' ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50 hover:border-gray-300'}`}
                >
                        <BarChart3 size={18}/> Bar
                </button>
                <button 
                        onClick={() => handleChange('chartType', 'line')}
                        className={`p-2.5 border rounded-lg flex items-center justify-center gap-2 text-sm transition-all ${node.params.chartType === 'line' ? 'bg-blue-50 border-blue-500 text-blue-700 ring-1 ring-blue-500' : 'border-gray-200 hover:bg-gray-50 hover:border-gray-300'}`}
                >
                        <TrendingUp size={18}/> Line
                </button>
              </div>
            </div>
                )}

                {/* Axis Config for Charts */}
                {node.params.subtype === 'CHART' && (
              <div className="space-y-4 pt-2 border-t border-gray-100">
                 <div className="space-y-1">
                  <label className="text-sm font-semibold text-gray-700 block">X Axis (Category)</label>
                  <select 
                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    value={node.params.xAxis || ''}
                    onChange={(e) => handleChange('xAxis', e.target.value)}
                  >
                    <option value="">Auto Select</option>
                    {schema.map(f => <option key={f} value={f}>{f}</option>)}
                  </select>
                </div>
                 <div className="space-y-1">
                  <label className="text-sm font-semibold text-gray-700 block">Y Axis (Value)</label>
                  <select 
                    className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                    value={node.params.yAxis || ''}
                    onChange={(e) => handleChange('yAxis', e.target.value)}
                  >
                    <option value="">Auto Select</option>
                    {schema.map(f => <option key={f} value={f}>{f}</option>)}
                  </select>
                </div>
                </div>
                )}

                {/* KPI / GAUGE metric config */}
                {(node.params.subtype === 'KPI' || node.params.subtype === 'GAUGE') && (
                  <div className="space-y-4">
                    <div className="space-y-1">
                      <label className="text-sm font-semibold text-gray-700 block">Aggregation</label>
                      <div className="flex bg-gray-100 p-1 rounded-lg">
                        {['count', 'sum', 'avg'].map((fn) => (
                          <button
                            key={fn}
                            onClick={() => handleChange('fn', fn)}
                            className={`flex-1 py-1.5 text-xs font-medium rounded-md capitalize transition-all ${node.params.fn === fn ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                          >
                            {fn}
                          </button>
                        ))}
                      </div>
                    </div>
                    {node.params.fn !== 'count' && (
                      <div className="space-y-1">
                        <label className="text-sm font-semibold text-gray-700 block">Metric Field</label>
                        <select
                          className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                          value={node.params.metricField || ''}
                          onChange={(e) => handleChange('metricField', e.target.value)}
                        >
                          <option value="">Select Numeric Field...</option>
                          {schema.map(f => <option key={f} value={f}>{f}</option>)}
                        </select>
              </div>
            )}
          </div>
        )}

                {/* Gauge target */}
                {node.params.subtype === 'GAUGE' && (
                  <div className="space-y-1 pt-2 border-t border-gray-100">
                    <label className="text-sm font-semibold text-gray-700 block">Target Value (Max)</label>
                    <input
                      type="number"
                      className="w-full p-2.5 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                      value={node.params.target || 100}
                      onChange={(e) => handleChange('target', Number(e.target.value))}
                    />
      </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    };

    // ---------------------------------------------------------------------
    // COMPONENT: Tree Node (recursive UI for branching graph)
    // ---------------------------------------------------------------------
    const TreeNode = ({
      nodeId,
      nodes,
      selectedNodeId,
      chainData,
      onSelect,
      onAdd,
      onInsert,
      onRemove,
      onToggleExpand,
      onToggleChildren,
      onToggleBranch,
      onDrillDown,
      onTableCellClick,
      showAddMenuForId,
      setShowAddMenuForId,
      showInsertMenuForId,
      setShowInsertMenuForId
    }) => {
      const node = nodes.find(n => n.id === nodeId);
      if (!node) return null;

      const result = getNodeResult(chainData, nodeId);
      const children = getChildren(nodes, nodeId);
      const isActive = selectedNodeId === nodeId;
      const isExpanded = node.isExpanded !== false;
      const areChildrenCollapsed = node.areChildrenCollapsed === true;
      const isBranchCollapsed = node.isBranchCollapsed === true;

      let Icon = Database;
      if (node.type === 'FILTER') Icon = Filter;
      if (node.type === 'AGGREGATE') Icon = Sigma;
      if (node.type === 'JOIN') Icon = LinkIcon;
      if (node.type === 'COMPONENT') {
        if (node.params.subtype === 'TABLE') Icon = TableIcon;
        if (node.params.subtype === 'CHART') Icon = BarChart3;
        if (node.params.subtype === 'KPI') Icon = Hash;
        if (node.params.subtype === 'GAUGE') Icon = Gauge;
      }

      const metricValue = (node.type === 'COMPONENT' && (node.params.subtype === 'KPI' || node.params.subtype === 'GAUGE') && result)
        ? calculateMetric(result.data, node.params.metricField, node.params.fn || 'count')
        : 0;

      const visibleColumns = (node.type === 'COMPONENT' && node.params.subtype === 'TABLE' && node.params.columns && node.params.columns.length > 0)
        ? node.params.columns
        : result ? result.schema : [];

      const hiddenCount = areChildrenCollapsed ? countDescendants(nodes, nodeId) : 0;

      // Compact collapsed branch representation
      if (isBranchCollapsed) {
        return (
          <div className="flex flex-col items-center animate-in fade-in zoom-in-95 duration-300">
            <div className="relative z-10">
              <div
                onClick={(e) => { e.stopPropagation(); onToggleBranch(nodeId); }}
                className="bg-white border border-gray-200 shadow-sm rounded-full px-4 py-2 flex items-center gap-2 cursor-pointer hover:border-blue-400 hover:text-blue-600 transition-all"
                title="Expand Branch"
              >
                <GitBranch size={14} className="text-indigo-500" />
                <span className="text-xs font-medium text-gray-600 truncate max-w-[150px]">{node.title}</span>
                <span className="text-[10px] text-gray-400 bg-gray-50 px-1.5 rounded-full border border-gray-100 flex items-center gap-0.5">
                  <Plus size={8} />
                  {countDescendants(nodes, nodeId) + 1}
                </span>
        </div>
      </div>
          </div>
        );
      }

      return (
        <div className="flex flex-col items-center animate-in fade-in zoom-in-95 duration-300">
          {/* NODE CARD */}
          <div className="relative group z-10">
            <div
              onClick={(e) => { e.stopPropagation(); onSelect(nodeId); }}
              className={`
                w-80 bg-white rounded-xl border-2 transition-all cursor-pointer overflow-hidden relative
                ${isActive ? 'border-blue-500 shadow-xl shadow-blue-500/10 ring-1 ring-blue-500 z-20' : 'border-gray-200 shadow-sm hover:border-gray-300 hover:shadow-md'}
              `}
            >
              {/* Header */}
              <div className="p-4 flex items-center gap-3">
                <button
                  onClick={(e) => { e.stopPropagation(); onToggleExpand(nodeId); }}
                  className="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded p-0.5 transition-colors"
                >
                  {isExpanded ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                </button>
                <div className={`w-10 h-10 rounded-lg flex items-center justify-center shrink-0 ${isActive ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-500'}`}>
                  <Icon size={20} />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <h4 className="font-bold text-gray-900 text-sm truncate">{node.title}</h4>
                    {node.branchName && (
                      <span className="bg-indigo-50 text-indigo-700 text-[9px] font-bold px-1.5 py-0.5 rounded border border-indigo-100 uppercase tracking-tight">
                        {node.branchName}
                      </span>
                    )}
                  </div>
                  <div className="text-xs text-gray-500 truncate mt-0.5">
                    {node.type === 'FILTER' && node.params.field ? `${node.params.field} ${node.params.operator} ${node.params.value}` :
                      node.type === 'AGGREGATE' ? `Group by ${node.params.groupBy}` :
                      node.type === 'JOIN' ? `with ${node.params.rightTable || '...'}` :
                      node.type === 'COMPONENT' ? `${node.params.subtype} View` :
                      node.description || node.type}
                  </div>
                </div>
                <div className="flex items-center gap-1">
                  <button
                    onClick={(e) => { e.stopPropagation(); onAdd('FILTER', nodeId); }}
                    className="p-1.5 hover:bg-gray-100 rounded text-gray-400 hover:text-indigo-600 transition-colors"
                    title="Fork Branch"
                  >
                    <GitBranch size={16} />
                  </button>

                  {children.length > 0 && (
                    <button
                      onClick={(e) => { e.stopPropagation(); onToggleChildren(nodeId); }}
                      className="p-1.5 hover:bg-gray-100 rounded text-gray-400 hover:text-indigo-600 transition-colors"
                      title={areChildrenCollapsed ? "Expand Children" : "Collapse Children"}
                    >
                      {areChildrenCollapsed ? <ChevronsDown size={16} /> : <ChevronsUp size={16} />}
                    </button>
                  )}

                  {node.parentId && (
                    <button
                      onClick={(e) => { e.stopPropagation(); onToggleBranch(nodeId); }}
                      className="p-1.5 hover:bg-gray-100 rounded text-gray-400 hover:text-indigo-600 transition-colors"
                      title="Minimize Node"
                    >
                      <Minimize2 size={16} />
                    </button>
                  )}

                  {node.type !== 'SOURCE' && (
                    <button
                      onClick={(e) => { e.stopPropagation(); onRemove(nodeId); }}
                      className="p-1.5 hover:bg-red-50 rounded text-gray-400 hover:text-red-500 transition-colors"
                    >
                      <Trash2 size={16} />
                    </button>
                  )}
                </div>
              </div>

              {/* Content Preview */}
              {isExpanded && result && (
                <div className="border-t border-gray-100 bg-gray-50 p-4 h-48 animate-in slide-in-from-top-2 duration-200 flex flex-col">
                  {/* TABLE VIEW */}
                  {(node.params.subtype === 'TABLE' || (node.type !== 'COMPONENT' && node.type !== 'JOIN')) && (
                    <div className="h-full overflow-hidden text-[10px] bg-white border border-gray-200 rounded p-2">
                      <div className="flex justify-between text-xs font-bold text-gray-500 mb-2">
                        <span>Preview</span>
                        <span>{result.data.length} rows</span>
                      </div>
                      <div className="overflow-auto h-[120px]">
                        <table className="w-full text-left border-collapse">
                          <thead>
                            <tr className="bg-gray-50 border-b sticky top-0 shadow-sm">
                              {visibleColumns.map(col => (
                                <th key={col} className="p-1 bg-gray-50 text-gray-600 font-medium whitespace-nowrap">{col}</th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {result.data.slice(0,10).map((r,i) => (
                              <tr key={i} className="border-b hover:bg-blue-50 transition-colors">
                                {visibleColumns.map(col => (
                                  <td
                                    key={col}
                                    className="p-1 truncate cursor-pointer hover:bg-blue-100 hover:text-blue-700 transition-colors max-w-[100px]"
                                    onClick={(e) => { e.stopPropagation(); onTableCellClick(r[col], col, nodeId); }}
                                    title={`Filter by ${col} = ${r[col]}`}
                                  >
                                    {r[col]}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {/* JOIN VIEW */}
                  {node.type === 'JOIN' && (
                    <div className="h-full bg-slate-900 rounded p-3 text-[10px] font-mono text-slate-300 overflow-auto">
                      <div><span className="text-pink-400">SELECT</span> *</div>
                      <div><span className="text-pink-400">FROM</span> [PreviousNode]</div>
                      <div><span className="text-pink-400">{node.params.joinType || 'LEFT'} JOIN</span> {node.params.rightTable || '...'}</div>
                      <div><span className="text-pink-400">ON</span> {node.params.leftKey || '?'} = {node.params.rightKey || '?'}</div>
                      <div className="mt-2 pt-2 border-t border-slate-700 text-slate-500 italic">
                        Result: {result.data.length} rows merged
                      </div>
                    </div>
                  )}

                  {/* CHART VIEW (simple SVG renderer) */}
                  {node.params.subtype === 'CHART' && (
                    <SimpleChart
                      data={result.data}
                      xAxis={node.params.xAxis}
                      yAxis={node.params.yAxis}
                      type={node.params.chartType || 'bar'}
                      onClick={(d) => onDrillDown(d, node.params.xAxis, nodeId)}
                    />
                  )}

                  {/* KPI VIEW */}
                  {node.params.subtype === 'KPI' && (
                    <div className="h-full flex flex-col items-center justify-center bg-white border border-gray-200 rounded p-4 text-center">
                      <div className="text-gray-400 text-xs font-medium uppercase tracking-wider mb-2">
                        {node.params.fn} of {node.params.metricField || 'records'}
                      </div>
                      <div className="text-4xl font-bold text-blue-600">
                        {formatNumber(metricValue)}
                      </div>
                    </div>
                  )}

                  {/* GAUGE VIEW */}
                  {node.params.subtype === 'GAUGE' && (
                    <div className="h-full flex flex-col items-center justify-center bg-white border border-gray-200 rounded p-4">
                      <div className="w-full flex justify-between text-xs text-gray-500 mb-1">
                        <span>{node.params.fn}</span>
                        <span>Target: {node.params.target || 100}</span>
                      </div>
                      <div className="text-3xl font-bold text-gray-900 mb-3">{formatNumber(metricValue)}</div>
                      <div className="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                        <div
                          className="h-full bg-blue-500 rounded-full transition-all duration-1000 ease-out"
                          style={{ width: `${Math.min(100, (metricValue / (node.params.target || 100)) * 100)}%` }}
                        ></div>
                      </div>
                      <div className="mt-2 text-[10px] text-gray-400">
                        {Math.round((metricValue / (node.params.target || 100)) * 100)}% of target
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* ADD BUTTON - Only show if NO children */}
            {children.length === 0 && (
              <div className={`absolute -bottom-6 left-1/2 -translate-x-1/2 translate-y-full z-20 transition-all ${!isExpanded ? '-mt-4' : ''}`}>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setShowAddMenuForId(showAddMenuForId === nodeId ? null : nodeId);
                  }}
                  className="w-8 h-8 bg-gray-100 hover:bg-blue-600 hover:text-white rounded-full flex items-center justify-center border-2 border-white shadow-sm transition-colors text-gray-400"
                >
                  <Plus size={16} strokeWidth={3} />
                </button>

                {showAddMenuForId === nodeId && (
                  <div className="absolute top-10 left-1/2 -translate-x-1/2 bg-white rounded-xl shadow-xl border border-gray-100 p-2 w-56 z-50 animate-in fade-in slide-in-from-top-1">
                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-2 py-1">Data Ops</div>
                    <button onClick={() => onAdd('FILTER', nodeId)} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 capitalize flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-orange-400"></div> Filter
                    </button>
                    <button onClick={() => onAdd('AGGREGATE', nodeId)} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 capitalize flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-purple-400"></div> Aggregate
                    </button>
                    <button onClick={() => onAdd('JOIN', nodeId)} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 capitalize flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-pink-400"></div> SQL Join
                    </button>

                    <div className="h-px bg-gray-100 my-1"></div>
                    <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-2 py-1">Components</div>

                    <button onClick={() => onAdd('COMPONENT', nodeId, 'TABLE')} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 flex items-center gap-2 group/item">
                      <TableIcon size={14} className="text-gray-400 group-hover/item:text-blue-600" /> Table
                    </button>
                    <button onClick={() => onAdd('COMPONENT', nodeId, 'CHART')} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 flex items-center gap-2 group/item">
                      <BarChart3 size={14} className="text-gray-400 group-hover/item:text-blue-600" /> Chart
                    </button>
                    <button onClick={() => onAdd('COMPONENT', nodeId, 'KPI')} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 flex items-center gap-2 group/item">
                      <Hash size={14} className="text-gray-400 group-hover/item:text-blue-600" /> KPI
                    </button>
                    <button onClick={() => onAdd('COMPONENT', nodeId, 'GAUGE')} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-sm text-gray-700 flex items-center gap-2 group/item">
                      <Gauge size={14} className="text-gray-400 group-hover/item:text-blue-600" /> Gauge
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* CONNECTORS & CHILDREN */}
          {children.length > 0 && (
            <div className="flex flex-col items-center">
              <div className="w-0.5 h-8 bg-gray-300 relative group/line">
                {!areChildrenCollapsed && (
                  <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 group-hover/line:opacity-100 transition-opacity z-30">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowInsertMenuForId(showInsertMenuForId === nodeId ? null : nodeId);
                      }}
                      className="w-5 h-5 bg-slate-800 text-white rounded-full flex items-center justify-center shadow-sm hover:scale-110 transition-transform"
                      title="Insert Step Here"
                    >
                      <Plus size={12} strokeWidth={3} />
                    </button>

                    {showInsertMenuForId === nodeId && (
                      <div className="absolute top-6 left-1/2 -translate-x-1/2 bg-white rounded-lg shadow-xl border border-gray-100 p-2 w-48 z-50 animate-in fade-in slide-in-from-top-1">
                        <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-2 py-1">Insert Step</div>
                        <button onClick={() => onInsert('FILTER', nodeId)} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-xs text-gray-700 capitalize flex items-center gap-2">
                          <div className="w-1.5 h-1.5 rounded-full bg-orange-400"></div> Filter
                        </button>
                        <button onClick={() => onInsert('AGGREGATE', nodeId)} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-xs text-gray-700 capitalize flex items-center gap-2">
                          <div className="w-1.5 h-1.5 rounded-full bg-purple-400"></div> Aggregate
                        </button>
                        <button onClick={() => onInsert('JOIN', nodeId)} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-xs text-gray-700 capitalize flex items-center gap-2">
                          <div className="w-1.5 h-1.5 rounded-full bg-pink-400"></div> Join
                        </button>
                        <div className="h-px bg-gray-100 my-1"></div>
                        <button onClick={() => onInsert('COMPONENT', nodeId, 'TABLE')} className="w-full text-left px-3 py-2 hover:bg-gray-50 rounded text-xs text-gray-700 flex items-center gap-2">
                          <TableIcon size={12} className="text-gray-400" /> Table
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {areChildrenCollapsed ? (
                <div className="flex flex-col items-center animate-in fade-in zoom-in-95">
                  <div className="w-0.5 h-4 border-l-2 border-dashed border-gray-300"></div>
                  {children.length > 1 ? (
                    <div className="relative flex flex-col items-center">
                      <div className="absolute left-full top-0 ml-2 -mt-2 z-20">
                        <button
                          onClick={(e) => { e.stopPropagation(); onToggleChildren(nodeId); }}
                          className="flex items-center gap-1 text-[10px] bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full border border-indigo-100 hover:bg-indigo-100 transition-colors whitespace-nowrap shadow-sm"
                        >
                          <GitBranch size={10} />
                          +{children.length - 1} branches
                        </button>
                      </div>
                      <TreeNode
                        nodeId={children[0].id}
                        nodes={nodes}
                        selectedNodeId={selectedNodeId}
                        chainData={chainData}
                        onSelect={onSelect}
                        onAdd={onAdd}
                        onInsert={onInsert}
                        onRemove={onRemove}
                        onToggleExpand={onToggleExpand}
                        onToggleChildren={onToggleChildren}
                        onToggleBranch={onToggleBranch}
                        onDrillDown={onDrillDown}
                        onTableCellClick={onTableCellClick}
                        showAddMenuForId={showAddMenuForId}
                        setShowAddMenuForId={setShowAddMenuForId}
                        showInsertMenuForId={showInsertMenuForId}
                        setShowInsertMenuForId={setShowInsertMenuForId}
                      />
                    </div>
                  ) : (
                    <div
                      onClick={() => onToggleChildren(nodeId)}
                      className="bg-gray-100 hover:bg-blue-50 text-gray-500 hover:text-blue-600 px-3 py-1 rounded-full text-xs font-medium border border-gray-200 cursor-pointer shadow-sm flex items-center gap-2"
                    >
                      <span>+ {hiddenCount} steps</span>
                    </div>
                  )}
                </div>
              ) : (
                children.length === 1 ? (
                  <TreeNode
                    nodeId={children[0].id}
                    nodes={nodes}
                    selectedNodeId={selectedNodeId}
                    chainData={chainData}
                    onSelect={onSelect}
                    onAdd={onAdd}
                    onInsert={onInsert}
                    onRemove={onRemove}
                    onToggleExpand={onToggleExpand}
                    onToggleChildren={onToggleChildren}
                    onToggleBranch={onToggleBranch}
                    onDrillDown={onDrillDown}
                    onTableCellClick={onTableCellClick}
                    showAddMenuForId={showAddMenuForId}
                    setShowAddMenuForId={setShowAddMenuForId}
                    showInsertMenuForId={showInsertMenuForId}
                    setShowInsertMenuForId={setShowInsertMenuForId}
                  />
                ) : (
                  <div className="flex flex-col items-center">
                    <div className="relative flex gap-8">
                      {children.map((child, idx) => (
                        <div key={child.id} className="flex flex-col items-center relative">
                          <div className="flex w-full h-4">
                            <div className={`w-1/2 border-t-2 border-gray-300 ${idx === 0 ? 'border-transparent' : ''}`}></div>
                            <div className={`w-1/2 border-t-2 border-gray-300 ${idx === children.length - 1 ? 'border-transparent' : ''}`}></div>
                          </div>
                          <div className="absolute top-0 w-0.5 h-4 bg-gray-300"></div>
                          <div className="pt-0">
                            <TreeNode
                              nodeId={child.id}
                              nodes={nodes}
                              selectedNodeId={selectedNodeId}
                              chainData={chainData}
                              onSelect={onSelect}
                              onAdd={onAdd}
                              onInsert={onInsert}
                              onRemove={onRemove}
                              onToggleExpand={onToggleExpand}
                              onToggleChildren={onToggleChildren}
                              onToggleBranch={onToggleBranch}
                              onDrillDown={onDrillDown}
                              onTableCellClick={onTableCellClick}
                              showAddMenuForId={showAddMenuForId}
                              setShowAddMenuForId={setShowAddMenuForId}
                              showInsertMenuForId={showInsertMenuForId}
                              setShowInsertMenuForId={setShowInsertMenuForId}
                            />
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )
              )}
            </div>
          )}
    </div>
  );
};

    // ---------------------------------------------------------------------
    // Simple SVG chart (bar/line) to keep this static build lightweight
    // ---------------------------------------------------------------------
    const SimpleChart = ({ data, xAxis, yAxis, type, onClick }) => {
      if (!xAxis || !yAxis || !data || data.length === 0) {
        return (
          <div className="h-full flex items-center justify-center text-xs text-gray-400">
            Configure axes to view a chart
          </div>
        );
      }

      const maxValue = Math.max(...data.map(d => Number(d[yAxis]) || 0), 1);
      const width = 300;
      const height = 140;
      const padding = 24;

      return (
        <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`} className="cursor-pointer">
          {/* Grid line */}
          <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#E5E7EB" />

          {type === 'line' ? (
            <polyline
              fill="none"
              stroke="#3B82F6"
              strokeWidth="2"
              points={data.map((d, i) => {
                const x = padding + (i * (width - 2 * padding) / Math.max(1, data.length - 1));
                const y = height - padding - ((Number(d[yAxis]) || 0) / maxValue) * (height - 2 * padding);
                return `${x},${y}`;
              }).join(' ')}
            />
          ) : (
            data.map((d, i) => {
              const x = padding + (i * (width - 2 * padding) / data.length);
              const barW = (width - 2 * padding) / data.length * 0.6;
              const h = ((Number(d[yAxis]) || 0) / maxValue) * (height - 2 * padding);
              return (
                <rect
                  key={i}
                  x={x - barW / 2}
                  y={height - padding - h}
                  width={barW}
                  height={h}
                  fill="#3B82F6"
                  onClick={() => onClick && onClick({ activePayload: [{ payload: d }] })}
                />
              );
            })
          )}
        </svg>
      );
    };

    // ---------------------------------------------------------------------
    // MAIN APP COMPONENT (merged tree engine + ingestion)
    // ---------------------------------------------------------------------
const AnalysisApp = () => {
      // ------------------
      // Ingestion state
      // ------------------
      const [dataModel, setDataModel] = useState({ tables: {}, order: [] });
      const [rawDataName, setRawDataName] = useState(null);
      const [loadError, setLoadError] = useState(null);
      const [isLoadingFile, setIsLoadingFile] = useState(false);
      const [selectedFile, setSelectedFile] = useState(null);
      const [pendingFile, setPendingFile] = useState(null);

      // ------------------
      // History state (undo / redo)
      // ------------------
      const [history, setHistory] = useState([
        [
          {
            id: 'node-start',
            parentId: null,
            type: 'SOURCE',
            title: 'Load Raw Data',
            description: 'Upload dataset',
            branchName: 'Main',
            isExpanded: true,
            params: { table: null, __file: null }
          }
        ]
      ]);
      const [historyIndex, setHistoryIndex] = useState(0);
      const nodes = history[historyIndex];

      const [selectedNodeId, setSelectedNodeId] = useState('node-start');
      const [showAddMenuForId, setShowAddMenuForId] = useState(null);
      const [showInsertMenuForId, setShowInsertMenuForId] = useState(null);
      const [showDataModel, setShowDataModel] = useState(false);

      // ------------------
      // File ingestion pipeline
      // ------------------
      useEffect(() => {
        let cancelled = false;

        const run = async () => {
          if (!selectedFile) {
            setIsLoadingFile(false);
            return;
          }

          setLoadError(null);
          setIsLoadingFile(true);

          try {
            await new Promise(resolve => setTimeout(resolve, 50));
            const name = selectedFile.name || 'Uploaded file';
            const lower = name.toLowerCase();

            let model = { tables: {}, order: [] };
            if (lower.endsWith('.csv')) {
              const text = await readFileAsText(selectedFile);
              const rows = parseCSV(text);
              if (!rows || rows.length === 0) throw new Error('No rows found in CSV.');
              model = buildDataModelFromCSV(name, rows);
            } else if (lower.endsWith('.xlsx') || lower.endsWith('.xls')) {
              if (!window.XLSX) throw new Error('Excel parsing library failed to load. Please refresh and try again.');
              const buf = await readFileAsArrayBuffer(selectedFile);
              const tables = parseXLSX(buf);
              const hasRows = Object.values(tables).some(arr => Array.isArray(arr) && arr.length > 0);
              if (!hasRows) throw new Error('No rows found in workbook.');
              model = buildDataModelFromXLSX(tables);
            } else {
              throw new Error('Unsupported file type. Please upload CSV or XLSX.');
            }

            if (!cancelled) {
              setDataModel(model);
              setRawDataName(name);
              // If source node has no table selected, set default
              const defaultTable = model.order[0] || null;
              if (defaultTable) {
                updateNode('node-start', { ...nodes.find(n => n.id === 'node-start').params, table: defaultTable }, false, true);
              }
            }
          } catch (err) {
            if (!cancelled) setLoadError(err?.message || String(err));
          } finally {
            if (!cancelled) setIsLoadingFile(false);
          }
        };

        run();
        return () => { cancelled = true; };
      }, [selectedFile]);

      // ------------------
      // History helpers
      // ------------------
      const updateNodes = (newNodes) => {
        const newHistory = history.slice(0, historyIndex + 1);
        newHistory.push(newNodes);
        setHistory(newHistory);
        setHistoryIndex(newHistory.length - 1);
      };

      const undo = () => { if (historyIndex > 0) setHistoryIndex(historyIndex - 1); };
      const redo = () => { if (historyIndex < history.length - 1) setHistoryIndex(historyIndex + 1); };

      // ------------------
      // Node updates (params + metadata)
      // ------------------
      const updateNode = (id, updates, isMeta = false, silent = false) => {
        const newNodes = nodes.map(n => {
          if (n.id !== id) return n;
          if (isMeta) return { ...n, ...updates };
          return { ...n, params: updates };
        });
        if (silent) {
          // Silent update: replace current history entry without creating a new one
          const newHistory = [...history];
          newHistory[historyIndex] = newNodes;
          setHistory(newHistory);
        } else {
          updateNodes(newNodes);
        }
      };

      // If user selects a file, keep it pending until they click ingest
      const updateNodeFromPanel = (id, params, isMeta = false) => {
        if (id === 'node-start' && params && Object.prototype.hasOwnProperty.call(params, '__file')) {
          setPendingFile(params.__file || null);
        }
        updateNode(id, params, isMeta);
      };

      const ingestPendingFile = () => {
        if (!pendingFile) {
          setLoadError('Please select a file to ingest.');
          return;
        }
        setLoadError(null);
        setSelectedFile(pendingFile);
      };

      // ------------------
      // Tree engine (process node graph)
      // ------------------
  const chainData = useMemo(() => {
        const order = getCalculationOrder(nodes);
        const resultsMap = new Map();

        for (const node of order) {
          // Parent data or empty if root
          let currentData = node.parentId && resultsMap.has(node.parentId)
            ? [...resultsMap.get(node.parentId).data]
            : [];

          // SOURCE = pick the selected table from ingestion model
      if (node.type === 'SOURCE') {
            const table = node.params.table || dataModel.order[0];
            currentData = table ? [...(dataModel.tables[table] || [])] : [];
      }

          // FILTER
      else if (node.type === 'FILTER' && node.params.field) {
        currentData = currentData.filter(item => {
              const val = item[node.params.field];
          const filterVal = node.params.value;
          if (!filterVal && filterVal !== 0) return true;
          if (node.params.operator === 'equals') return String(val) == String(filterVal);
          if (node.params.operator === 'not_equals') return String(val) != String(filterVal);
          if (node.params.operator === 'contains') return String(val).toLowerCase().includes(String(filterVal).toLowerCase());
          return true;
        });
      }

          // AGGREGATE
      else if (node.type === 'AGGREGATE' && node.params.groupBy) {
            const groups = {};
        currentData.forEach(item => {
              const key = item[node.params.groupBy];
          if (!groups[key]) groups[key] = { [node.params.groupBy]: key, _count: 0, _sum: 0, _raw: [] };
          groups[key]._count++;
          groups[key]._raw.push(item);
          if (node.params.metricField) {
                groups[key]._sum += (Number(item[node.params.metricField]) || 0);
          }
        });
            currentData = Object.values(groups).map((g) => {
              const res = { [node.params.groupBy]: g[node.params.groupBy] };
          if (node.params.fn === 'sum') res[node.params.metricField] = g._sum;
          else if (node.params.fn === 'avg') res[node.params.metricField] = Math.round(g._sum / g._count);
          else res['Record Count'] = g._count;
          return res;
        });
      }

          // JOIN
          else if (node.type === 'JOIN' && node.params.rightTable && node.params.leftKey && node.params.rightKey) {
            const rightTableData = dataModel.tables[node.params.rightTable] || [];
            const rightTablePrefix = node.params.rightTable;
            const joinedData = [];
            const matchedRightIndices = new Set();

            const prefixColumns = (row, prefix) => {
              return Object.entries(row).reduce((acc, [key, val]) => {
                acc[`${prefix}_${key}`] = val;
                return acc;
              }, {});
            };

            currentData.forEach(leftRow => {
              const leftVal = leftRow[node.params.leftKey];
              let matchesFound = false;
              if (leftVal !== undefined && leftVal !== null && leftVal !== '') {
                rightTableData.forEach((rightRow, rIdx) => {
                  if (String(rightRow[node.params.rightKey]) === String(leftVal)) {
                    matchesFound = true;
                    matchedRightIndices.add(rIdx);
                    joinedData.push({ ...leftRow, ...prefixColumns(rightRow, rightTablePrefix) });
                  }
                });
              }
              if (!matchesFound && ['LEFT', 'FULL'].includes(node.params.joinType || 'LEFT')) {
                joinedData.push({ ...leftRow });
              }
            });

            if (['RIGHT', 'FULL'].includes(node.params.joinType)) {
              rightTableData.forEach((rightRow, rIdx) => {
                if (!matchedRightIndices.has(rIdx)) {
                  joinedData.push({ ...prefixColumns(rightRow, rightTablePrefix) });
                }
              });
            }

            currentData = joinedData;
          }

          // Schema extraction (robust for joins/empties)
          const uniqueKeys = new Set();
          if (currentData.length > 0) {
            currentData.slice(0, 10).forEach(row => {
              Object.keys(row).forEach(k => uniqueKeys.add(k));
            });
          }

          if (node.type === 'JOIN' && node.params.rightTable) {
            const proto = (dataModel.tables[node.params.rightTable] || [])[0];
            if (proto) Object.keys(proto).forEach(k => uniqueKeys.add(`${node.params.rightTable}_${k}`));
          }

          resultsMap.set(node.id, {
            nodeId: node.id,
            data: currentData,
            schema: Array.from(uniqueKeys)
          });
        }

        return Array.from(resultsMap.values());
      }, [nodes, dataModel]);

      // ------------------
      // Node operations
      // ------------------
      const addNode = (type, parentId, subtype = 'TABLE') => {
        const newId = `node-${Date.now()}`;
        const siblings = getChildren(nodes, parentId);
        const branchName = siblings.length > 0 ? `Fork ${siblings.length + 1}` : undefined;

        const newNode = {
          id: newId,
          parentId,
          type,
          title: 'New Step',
          branchName,
          isExpanded: true,
          params: { subtype, operator: 'equals', fn: 'count', chartType: 'bar', target: 100, joinType: 'LEFT' }
        };

        const updatedNodes = nodes.map(n => n.id === parentId ? { ...n, areChildrenCollapsed: false } : n);
        updateNodes([...updatedNodes, newNode]);
    setSelectedNodeId(newId);
        setShowAddMenuForId(null);
      };

      const insertNode = (type, parentId, subtype = 'TABLE') => {
        const newId = `node-${Date.now()}`;
        const newNode = {
          id: newId,
          parentId,
          type,
          title: 'Inserted Step',
          isExpanded: true,
          params: { subtype, operator: 'equals', fn: 'count', chartType: 'bar', target: 100, joinType: 'LEFT' }
        };

        let updatedNodes = nodes.map(n => n.id === parentId ? { ...n, areChildrenCollapsed: false } : n);
        updatedNodes = updatedNodes.map(n => n.parentId === parentId ? { ...n, parentId: newId } : n);

        updateNodes([...updatedNodes, newNode]);
        setSelectedNodeId(newId);
        setShowInsertMenuForId(null);
      };

      const removeNode = (id) => {
        const nodesToDelete = new Set([id]);
        let poolToCheck = [id];
        while (poolToCheck.length > 0) {
          const current = poolToCheck.pop();
          const children = getChildren(nodes, current);
          children.forEach(c => { nodesToDelete.add(c.id); poolToCheck.push(c.id); });
        }
        const filtered = nodes.filter(n => !nodesToDelete.has(n.id));
        updateNodes(filtered);
    if (selectedNodeId === id) setSelectedNodeId('node-start');
  };

      const toggleNodeExpansion = (id) => {
        const newNodes = nodes.map(n => n.id === id ? { ...n, isExpanded: !n.isExpanded } : n);
        const newHistory = [...history];
        newHistory[historyIndex] = newNodes;
        setHistory(newHistory);
      };

      const toggleChildrenCollapse = (id) => {
        const newNodes = nodes.map(n => n.id === id ? { ...n, areChildrenCollapsed: !n.areChildrenCollapsed } : n);
        const newHistory = [...history];
        newHistory[historyIndex] = newNodes;
        setHistory(newHistory);
      };

      const toggleBranchCollapse = (id) => {
        const newNodes = nodes.map(n => n.id === id ? { ...n, isBranchCollapsed: !n.isBranchCollapsed } : n);
        const newHistory = [...history];
        newHistory[historyIndex] = newNodes;
        setHistory(newHistory);
      };

      const handleSelect = (id) => {
        setSelectedNodeId(id);
        const newNodes = nodes.map(n => n.id === id ? { ...n, isExpanded: true } : n);
        const newHistory = [...history];
        newHistory[historyIndex] = newNodes;
        setHistory(newHistory);
      };

      const handleChartDrillDown = (data, xAxisField, parentId) => {
    if (!data || !data.activePayload) return;
        addNode('FILTER', parentId);
      };

      const handleTableCellClick = (value, field, parentId) => {
        const newId = `node-${Date.now()}`;
        const newNode = {
          id: newId,
          parentId,
          type: 'FILTER',
          title: 'Filter Data',
          isExpanded: true,
          params: { field, operator: 'equals', value }
        };

        const updatedNodes = nodes.map(n => n.id === parentId ? { ...n, areChildrenCollapsed: false } : n);
        updateNodes([...updatedNodes, newNode]);
        setSelectedNodeId(newId);
      };

      // ------------------
      // Derived status for SOURCE panel
      // ------------------
      const sourceStatus = (() => {
        if (isLoadingFile) return { title: 'Loading…', detail: 'Parsing file and building table…', loading: true };
        if (loadError) return { title: 'Error', detail: loadError };
        const count = dataModel.order.length
          ? (dataModel.tables[(nodes.find(n => n.id === 'node-start')?.params.table) || dataModel.order[0]] || []).length
          : 0;
        return { title: 'Connected', detail: `${rawDataName || 'Dataset'} loaded with ${count} rows.` };
      })();

      // ------------------
      // Render
      // ------------------
  return (
    <div className="flex h-screen w-full bg-slate-50 font-sans text-slate-900 overflow-hidden">
      {/* 1. LEFT SIDEBAR */}
          <div className="w-16 flex-shrink-0 bg-slate-900 flex flex-col items-center py-6 gap-6 text-slate-400 border-r border-slate-800 z-50">
        <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl flex items-center justify-center text-white font-bold shadow-lg shadow-blue-900/50 mb-4 ring-1 ring-white/10">
          <Layout size={20} />
        </div>
            <div
              onClick={() => setShowDataModel(true)}
              className="p-2.5 bg-slate-800 rounded-lg hover:bg-slate-700 cursor-pointer transition-colors text-white relative group"
              title="Data Model"
            >
          <Database size={20} />
        </div>
        <div className="p-2.5 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors relative group" title="Saved Analysis">
          <FileJson size={20} />
        </div>
        <div className="mt-auto p-2.5 hover:bg-slate-800 rounded-lg cursor-pointer transition-colors relative group">
          <Settings size={20} />
        </div>
      </div>

      {/* 2. MAIN CANVAS AREA */}
      <div className="flex-1 flex flex-col relative overflow-hidden bg-[#F8FAFC]">
            <header className="h-16 bg-white border-b border-gray-200 flex items-center px-8 justify-between shadow-sm z-40 relative">
          <div className="flex items-center gap-4">
                <h1 className="font-bold text-gray-900 text-lg">Invoice Analysis <span className="text-gray-400 font-normal mx-2">/</span> Canvas</h1>
          </div>
          <div className="flex items-center gap-3">
                <div className="flex items-center bg-gray-100 rounded-lg p-1">
                  <button onClick={undo} disabled={historyIndex === 0} className="p-1.5 text-gray-600 hover:bg-white rounded disabled:opacity-30 disabled:hover:bg-transparent" title="Undo">
                    <Undo size={16} />
            </button>
                  <button onClick={redo} disabled={historyIndex === history.length - 1} className="p-1.5 text-gray-600 hover:bg-white rounded disabled:opacity-30 disabled:hover:bg-transparent" title="Redo">
                    <Redo size={16} />
            </button>
                </div>
                <button className="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm">Save</button>
          </div>
        </header>

            {/* Infinite canvas scroll area */}
            <div
              className="flex-1 overflow-auto bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] bg-slate-50 cursor-grab active:cursor-grabbing"
              onClick={() => {
                setShowAddMenuForId(null);
                setShowInsertMenuForId(null);
              }}
            >
              <div className="min-w-full inline-flex justify-center p-20 items-start min-h-full">
                <TreeNode
                  nodeId="node-start"
                  nodes={nodes}
                  selectedNodeId={selectedNodeId}
                  chainData={chainData}
                  onSelect={handleSelect}
                  onAdd={addNode}
                  onInsert={insertNode}
                  onRemove={removeNode}
                  onToggleExpand={toggleNodeExpansion}
                  onToggleChildren={toggleChildrenCollapse}
                  onToggleBranch={toggleBranchCollapse}
                  onDrillDown={handleChartDrillDown}
                  onTableCellClick={handleTableCellClick}
                  showAddMenuForId={showAddMenuForId}
                  setShowAddMenuForId={setShowAddMenuForId}
                  showInsertMenuForId={showInsertMenuForId}
                  setShowInsertMenuForId={setShowInsertMenuForId}
                />
                        </div>
                          </div>
                        </div>

          {/* 3. PROPERTIES PANEL */}
          <PropertiesPanel
            node={nodes.find(n => n.id === selectedNodeId)}
            updateNode={updateNodeFromPanel}
            schema={getNodeResult(chainData, selectedNodeId)?.schema || []}
            dataModel={dataModel}
            sourceStatus={sourceStatus}
            onIngest={ingestPendingFile}
          />

          {/* 4. DATA MODEL MODAL */}
          {showDataModel && (
            <div className="absolute inset-0 z-[60] bg-black/50 flex items-center justify-center p-8 backdrop-blur-sm animate-in fade-in duration-200">
              <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden">
                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-100 p-2 rounded text-blue-600"><Database size={20} /></div>
                    <div>
                      <h2 className="font-bold text-lg text-gray-900">Data Model Preview</h2>
                      <p className="text-sm text-gray-500">Available tables and schemas</p>
                          </div>
                            </div>
                  <button onClick={() => setShowDataModel(false)} className="p-2 hover:bg-gray-200 rounded-full text-gray-500"><X size={20} /></button>
                        </div>
                <div className="flex-1 overflow-auto p-8 bg-slate-50">
                  {dataModel.order.length === 0 ? (
                    <div className="text-sm text-gray-500">Upload a CSV/XLSX file to populate the data model.</div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      {dataModel.order.map(tableName => (
                        <div key={tableName} className="bg-white rounded-lg border border-gray-200 shadow-sm flex flex-col">
                          <div className="p-4 border-b border-gray-100 font-bold text-gray-800 flex items-center gap-2">
                            <TableIcon size={16} className="text-gray-400" />
                            {tableName.toUpperCase()}
                      </div>
                          <div className="p-0">
                            <table className="w-full text-sm text-left">
                              <thead className="bg-gray-50 text-gray-500 text-xs uppercase">
                                <tr><th className="p-3 font-semibold">Column</th><th className="p-3 font-semibold">Sample</th></tr>
                                    </thead>
                              <tbody className="divide-y divide-gray-100">
                                {Object.keys((dataModel.tables[tableName] || [])[0] || {}).map(col => (
                                  <tr key={col}>
                                    <td className="p-3 font-medium text-gray-700">{col}</td>
                                    <td className="p-3 text-gray-400 truncate max-w-[100px]">{String((dataModel.tables[tableName] || [])[0]?.[col] || '')}</td>
                                        </tr>
                                      ))}
                                    </tbody>
                                  </table>
                                </div>
                          <div className="mt-auto p-3 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 text-center">
                            {(dataModel.tables[tableName] || []).length} total records
                                  </div>
                                </div>
                      ))}
                                </div>
                              )}
                            </div>
                        </div>
                            </div>
                          )}
                  </div>
                );
    };

    // Boot the app with basic runtime diagnostics (helps if CDN scripts fail)
    const showBootError = (msg) => {
      const el = document.getElementById('boot-error');
      if (!el) return;
      el.style.display = 'block';
      el.textContent = msg;
    };

    if (!window.React || !window.ReactDOM) {
      showBootError('React failed to load. Please refresh and ensure CDN access is available.');
    } else {
      try {
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AnalysisApp />);
      } catch (err) {
        showBootError(`App failed to start: ${err?.message || err}`);
        // Also log full error for debugging
        console.error(err);
      }
    }
  </script>
</body>
</html>
